<!doctype html>
<html lang="de">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MS Parsch - Mathematik</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f5dc 0%, #e8d7c3 100%);
      width: 100%;
      height: 100%;
      overflow-auto;
    }

    html {
      height: 100%;
      width: 100%;
    }

    .app-wrapper {
      min-height: 100%;
      width: 100%;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .math-symbols {
      position: fixed;
      font-size: 60px;
      opacity: 0.08;
      color: #2c5f8d;
      pointer-events: none;
      z-index: 0;
    }

    .symbol-1 { top: 10%; left: 5%; transform: rotate(-15deg); }
    .symbol-2 { top: 20%; right: 8%; transform: rotate(20deg); }
    .symbol-3 { bottom: 15%; left: 10%; transform: rotate(10deg); }
    .symbol-4 { bottom: 25%; right: 5%; transform: rotate(-20deg); }
    .symbol-5 { top: 50%; left: 3%; transform: rotate(25deg); }
    .symbol-6 { top: 60%; right: 6%; transform: rotate(-10deg); }

    .content {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      width: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 50px;
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(44, 95, 141, 0.15);
    }

    h1 {
      margin: 0;
      font-size: 144px;
      background: linear-gradient(135deg, #2c5f8d 0%, #4a8fc7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      line-height: 1.2;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #d4c4b0;
      color: #2c5f8d;
      border: none;
      padding: 15px 30px;
      font-size: 20px;
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 30px;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .back-button:hover {
      background: #c4b4a0;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .class-grid {
      display: flex;
      flex-direction: column;
      gap: 25px;
      margin-top: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .class-card {
      background: white;
      border-radius: 20px;
      padding: 30px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
      box-shadow: 0 6px 20px rgba(44, 95, 141, 0.12);
      position: relative;
      overflow: hidden;
      width: 100%;
    }

    .class-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #2c5f8d 0%, #4a8fc7 100%);
    }

    .class-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 32px rgba(44, 95, 141, 0.2);
      border-color: #4a8fc7;
    }

    .class-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .class-title {
      font-size: 32px;
      color: #2c5f8d;
      font-weight: 700;
      margin: 0;
    }

    .topics-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 24px rgba(44, 95, 141, 0.15);
    }

    .topics-title {
      font-size: 36px;
      color: #2c5f8d;
      margin-bottom: 30px;
      text-align: center;
    }

    .empty-topics {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 22px;
    }

    .empty-icon {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .topics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .topic-button {
      background: linear-gradient(135deg, #2c5f8d 0%, #4a8fc7 100%);
      color: white;
      border: none;
      padding: 25px 30px;
      font-size: 22px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(44, 95, 141, 0.3);
      text-align: center;
    }

    .topic-button:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(44, 95, 141, 0.4);
      background: linear-gradient(135deg, #4a8fc7 0%, #2c5f8d 100%);
    }

    /* Exercise Styles */
    .exercise-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 24px rgba(44, 95, 141, 0.15);
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .exercise-progress {
      font-size: 20px;
      color: #2c5f8d;
      font-weight: 600;
    }

    .exercise-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tip-button, .check-button, .next-button, .new-button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .tip-button {
      background: #f0ad4e;
      color: white;
    }

    .tip-button:hover {
      background: #ec971f;
      transform: translateY(-2px);
    }

    .check-button {
      background: #5cb85c;
      color: white;
    }

    .check-button:hover {
      background: #4cae4c;
      transform: translateY(-2px);
    }

    .next-button, .new-button {
      background: #2c5f8d;
      color: white;
    }

    .next-button:hover, .new-button:hover {
      background: #4a8fc7;
      transform: translateY(-2px);
    }

    .exercise-question {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 25px;
      border-left: 5px solid #2c5f8d;
    }

    .question-text {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .answer-area {
      margin-top: 20px;
    }

    .answer-input {
      padding: 12px 20px;
      font-size: 20px;
      border: 2px solid #ccc;
      border-radius: 8px;
      margin: 5px;
      width: 120px;
      text-align: center;
    }

    .answer-input:focus {
      outline: none;
      border-color: #2c5f8d;
    }

    .answer-textarea {
      padding: 12px 20px;
      font-size: 18px;
      border: 2px solid #ccc;
      border-radius: 8px;
      width: 100%;
      min-height: 100px;
      font-family: inherit;
      resize: vertical;
    }

    .answer-textarea:focus {
      outline: none;
      border-color: #2c5f8d;
    }

    .tip-box, .feedback-box {
      background: #fff3cd;
      border: 2px solid #f0ad4e;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
    }

    .feedback-box.correct {
      background: #d4edda;
      border-color: #5cb85c;
    }

    .feedback-box.incorrect {
      background: #f8d7da;
      border-color: #dc3545;
    }

    .tip-box.show, .feedback-box.show {
      display: block;
    }

    .tip-title, .solution-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #2c5f8d;
    }

    .tip-content, .solution-content {
      font-size: 18px;
      line-height: 1.6;
      color: #333;
    }

    .number-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    .number-box {
      background: white;
      border: 2px solid #2c5f8d;
      padding: 15px 25px;
      border-radius: 8px;
      font-size: 24px;
      font-weight: 700;
      color: #2c5f8d;
    }

    .stellenwert-table {
      width: auto;
      max-width: 100%;
      border-collapse: collapse;
      margin: 20px auto;
      font-size: 16px;
    }

    .stellenwert-table th,
    .stellenwert-table td {
      border: 2px solid #2c5f8d;
      padding: 8px 10px;
      text-align: center;
    }

    .stellenwert-table th {
      background: #2c5f8d;
      color: white;
      font-weight: 700;
      font-size: 14px;
    }

    .stellenwert-table input {
      width: 40px;
      padding: 6px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    .stellenwert-table th.comma-col {
      background: #f0ad4e;
      font-size: 20px;
    }

    .zahlenstrahl {
      position: relative;
      height: 120px;
      background: white;
      border: 2px solid #2c5f8d;
      border-radius: 10px;
      margin: 30px 0;
      padding: 10px 0;
    }

    .zahlenstrahl-line {
      position: absolute;
      top: 50%;
      left: 5%;
      right: 5%;
      height: 3px;
      background: #2c5f8d;
      transform: translateY(-50%);
    }

    .zahlenstrahl-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 20px;
      background: #2c5f8d;
      pointer-events: none;
    }

    .zahlenstrahl-label {
      position: absolute;
      top: 75%;
      transform: translateX(-50%);
      font-size: 14px;
      font-weight: 600;
      color: #2c5f8d;
      pointer-events: none;
    }

    .zahlenstrahl-clickable {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s ease;
    }

    .zahlenstrahl-clickable:hover {
      background: rgba(44, 95, 141, 0.1);
      border-radius: 50%;
    }

    .zahlenstrahl-x {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      color: #e74c3c;
      font-weight: bold;
      pointer-events: none;
      line-height: 1;
    }

    .zahlenstrahl-clickable.marked {
      background: rgba(231, 76, 60, 0.1);
      border-radius: 50%;
    }

    .calculation-display {
      background: white;
      border: 2px solid #2c5f8d;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 24px;
      text-align: right;
      line-height: 1.8;
      margin: 20px 0;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 64px;
      }

      .question-text {
        font-size: 20px;
      }

      .answer-input {
        width: 80px;
        font-size: 18px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="math-symbols symbol-1">
   ‚àë
  </div>
  <div class="math-symbols symbol-2">
   œÄ
  </div>
  <div class="math-symbols symbol-3">
   ‚àö
  </div>
  <div class="math-symbols symbol-4">
   ‚àû
  </div>
  <div class="math-symbols symbol-5">
   √∑
  </div>
  <div class="math-symbols symbol-6">
   √ó
  </div>
  <div class="app-wrapper">
   <div class="content">
    <header>
     <h1 id="mainTitle">MS Parsch - Mathematik</h1>
    </header><!-- Main View: Class Selection -->
    <main id="mainView">
     <div class="class-grid">
      <div class="class-card" data-class="class1">
       <div class="class-icon">
        1Ô∏è‚É£
       </div>
       <h2 class="class-title" id="class1Label">1. Klasse</h2>
      </div>
      <div class="class-card" data-class="class2">
       <div class="class-icon">
        2Ô∏è‚É£
       </div>
       <h2 class="class-title" id="class2Label">2. Klasse</h2>
      </div>
      <div class="class-card" data-class="class3">
       <div class="class-icon">
        3Ô∏è‚É£
       </div>
       <h2 class="class-title" id="class3Label">3. Klasse</h2>
      </div>
      <div class="class-card" data-class="class4">
       <div class="class-icon">
        4Ô∏è‚É£
       </div>
       <h2 class="class-title" id="class4Label">4. Klasse</h2>
      </div>
      <div class="class-card" data-class="dfk">
       <div class="class-icon">
        üìö
       </div>
       <h2 class="class-title" id="dfkLabel">DFK</h2>
      </div>
     </div>
    </main><!-- Topics View -->
    <div id="topicsView" class="hidden"><button class="back-button" id="backToMainBtn"> ‚Üê Zur√ºck zur Klassenauswahl </button>
     <div class="topics-container">
      <h2 class="topics-title" id="topicsTitle"></h2>
      <div id="topicsContent"></div>
     </div>
    </div><!-- Exercise View -->
    <div id="exerciseView" class="hidden"><button class="back-button" id="backToTopicsBtn"> ‚Üê Zur√ºck zu den Themen </button>
     <div class="exercise-container">
      <div class="exercise-header">
       <h2 class="topics-title" id="exerciseTitle"></h2>
       <div class="exercise-progress" id="exerciseProgress"></div>
      </div>
      <div class="exercise-controls"><button class="tip-button" onclick="toggleTip()">üí° Tipp anzeigen</button> <button class="check-button" onclick="checkAnswer()">‚úì Antwort pr√ºfen</button>
      </div>
      <div class="exercise-question">
       <div class="question-text" id="questionText"></div>
       <div class="answer-area" id="answerArea"></div>
      </div>
      <div class="tip-box" id="tipBox">
       <div class="tip-title">
        üí° Tipp:
       </div>
       <div class="tip-content" id="tipContent"></div>
      </div>
      <div class="feedback-box" id="feedbackBox">
       <div class="tip-title" id="feedbackTitle"></div>
       <div class="tip-content" id="feedbackContent"></div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      main_title: "MS Parsch - Mathematik",
      class_1_label: "1. Klasse",
      class_2_label: "2. Klasse",
      class_3_label: "3. Klasse",
      class_4_label: "4. Klasse",
      dfk_label: "DFK"
    };

    const classTopics = {
      class1: [
        "Nat√ºrliche Zahlen",
        "Grundrechenarten",
        "Zeitma√üe",
        "Geometrische Grundbegriffe",
        "Winkel",
        "Kommazahlen",
        "L√§ngenma√üe",
        "Massenma√üe",
        "Rechteck und Quadrat",
        "K√∂rper",
        "Kreis"
      ],
      class2: [
        "Br√ºche"
      ],
      class3: [],
      class4: [
        "Kreis",
        "Satz des Pythagoras",
        "Potenzen",
        "Terme",
        "Kreisteile",
        "Reelle Zahlen",
        "Gleichungen",
        "Binomische Formeln",
        "Funktionen",
        "Prisma und Pyramide",
        "Prozentrechnung",
        "Statistik",
        "Jahresabschluss"
      ],
      dfk: []
    };

    const learningGoals = {
      "Br√ºche": [
        {
          title: "Teile eines Bruchs benennen",
          type: "fraction_parts",
          exercises: 2
        },
        {
          title: "Br√ºche darstellen",
          type: "fraction_visual",
          exercises: 50
        },
        {
          title: "Arten von Br√ºchen unterscheiden",
          type: "fraction_types",
          exercises: 50
        },
        {
          title: "Br√ºche erweitern",
          type: "fraction_expand",
          exercises: 50
        },
        {
          title: "Br√ºche k√ºrzen",
          type: "fraction_reduce",
          exercises: 50
        },
        {
          title: "Br√ºche mit gemeinsamem Nenner addieren",
          type: "fraction_add_same",
          exercises: 50
        },
        {
          title: "Br√ºche mit gemeinsamem Nenner subtrahieren",
          type: "fraction_subtract_same",
          exercises: 50
        },
        {
          title: "2 Br√ºche addieren (verschiedene Nenner)",
          type: "fraction_add_different",
          exercises: 50
        },
        {
          title: "2 Br√ºche subtrahieren (verschiedene Nenner)",
          type: "fraction_subtract_different",
          exercises: 50
        },
        {
          title: "3 Br√ºche addieren und subtrahieren",
          type: "fraction_three_operations",
          exercises: 50
        },
        {
          title: "Br√ºche in Dezimalzahlen umwandeln",
          type: "fraction_to_decimal",
          exercises: 50
        },
        {
          title: "Dezimalzahlen in Br√ºche umwandeln",
          type: "decimal_to_fraction",
          exercises: 50
        },
        {
          title: "Gemischte Zahlen in unechte Br√ºche",
          type: "mixed_to_improper",
          exercises: 50
        },
        {
          title: "Gemischte Zahlen addieren",
          type: "mixed_addition",
          exercises: 50
        },
        {
          title: "Gemischte Zahlen subtrahieren",
          type: "mixed_subtraction",
          exercises: 50
        },
        {
          title: "Br√ºche multiplizieren",
          type: "fraction_multiply",
          exercises: 50
        },
        {
          title: "Br√ºche mit nat√ºrlichen Zahlen multiplizieren",
          type: "fraction_multiply_natural",
          exercises: 50
        },
        {
          title: "Mit gemischten Zahlen multiplizieren",
          type: "mixed_multiply",
          exercises: 50
        },
        {
          title: "Kehrwert eines Bruchs bilden",
          type: "fraction_reciprocal",
          exercises: 50
        },
        {
          title: "Br√ºche dividieren",
          type: "fraction_divide",
          exercises: 50
        },
        {
          title: "Br√ºche durch nat√ºrliche Zahlen dividieren",
          type: "fraction_divide_natural",
          exercises: 50
        },
        {
          title: "Mit gemischten Zahlen dividieren",
          type: "mixed_divide",
          exercises: 50
        },
        {
          title: "Vorrangregeln bei Br√ºchen",
          type: "fraction_order",
          exercises: 50
        },
        {
          title: "Textaufgaben zu Br√ºchen l√∂sen",
          type: "fraction_word_problems",
          exercises: 50
        }
      ],
      "Nat√ºrliche Zahlen": [
        {
          title: "Zahlen ordnen",
          type: "ordering",
          exercises: 50
        },
        {
          title: "Vorg√§nger & Nachfolger",
          type: "predecessor",
          exercises: 50
        },
        {
          title: "Stellenwerttabelle",
          type: "stellenwert",
          exercises: 50
        },
        {
          title: "Zahlen runden",
          type: "rounding",
          exercises: 50
        },
        {
          title: "Ziffer vs. Zahl",
          type: "definition",
          exercises: 50
        },
        {
          title: "Zahlenstrahl",
          type: "numberline",
          exercises: 50
        }
      ],
      "Kommazahlen": [
        {
          title: "Dezimalzahlen in Stellenwerttabelle",
          type: "decimal_stellenwert",
          exercises: 50
        },
        {
          title: "Dezimalzahlen ordnen",
          type: "decimal_ordering",
          exercises: 50
        },
        {
          title: "Stellenwert bestimmen",
          type: "decimal_place_value",
          exercises: 50
        },
        {
          title: "Zahlenstrahl eintragen",
          type: "decimal_numberline_mark",
          exercises: 50
        },
        {
          title: "Zahlenstrahl ablesen",
          type: "decimal_numberline_read",
          exercises: 50
        },
        {
          title: "Dezimalzahlen runden",
          type: "decimal_rounding",
          exercises: 50
        },
        {
          title: "Geldbetr√§ge umwandeln",
          type: "money_conversion",
          exercises: 50
        },
        {
          title: "Stellenwertrichtig untereinander",
          type: "decimal_alignment",
          exercises: 50
        },
        {
          title: "Dezimalzahlen addieren",
          type: "decimal_addition",
          exercises: 50
        },
        {
          title: "Dezimalzahlen subtrahieren",
          type: "decimal_subtraction",
          exercises: 50
        },
        {
          title: "Mit nat√ºrlichen Zahlen multiplizieren",
          type: "decimal_multiply_natural",
          exercises: 50
        },
        {
          title: "Mit Dezimalzahlen multiplizieren",
          type: "decimal_multiply_decimal",
          exercises: 50
        },
        {
          title: "Mit 10, 100, 1000 multiplizieren",
          type: "decimal_multiply_powers",
          exercises: 50
        },
        {
          title: "Durch 10, 100, 1000 dividieren",
          type: "decimal_divide_powers",
          exercises: 50
        },
        {
          title: "Nat√ºrliche Zahlen dividieren",
          type: "natural_divide_decimal",
          exercises: 50
        },
        {
          title: "Dezimalzahlen durch nat√ºrliche Zahlen",
          type: "decimal_divide_natural",
          exercises: 50
        }
      ],
      "Gleichungen": [
        {
          title: "Einschrittige Gleichungen sicher l√∂sen",
          type: "one_step_equations",
          exercises: 50
        },
        {
          title: "Einfache mehrschrittige Gleichungen l√∂sen",
          type: "simple_multi_step_equations",
          exercises: 50
        },
        {
          title: "Komplexe mehrschrittige Gleichungen l√∂sen",
          type: "complex_multi_step_equations",
          exercises: 50
        },
        {
          title: "Die Probe durchf√ºhren",
          type: "equation_proof",
          exercises: 50
        },
        {
          title: "Quadratische Gleichungen l√∂sen",
          type: "quadratic_equations",
          exercises: 50
        },
        {
          title: "Einfache Textgleichungen aufstellen",
          type: "text_equations",
          exercises: 50
        },
        {
          title: "üéÆ Abschlussspiel",
          type: "final_game",
          exercises: 1
        }
      ]
    };

    let currentView = 'main';
    let currentClass = '';
    let currentTopic = '';
    let currentGoalIndex = -1;
    let currentExerciseIndex = 0;
    let currentExercises = [];
    let attemptCount = 0;

    const EXERCISES_PER_LEVEL = 5;

    // Fraction helper functions
    function gcd(a, b) {
      a = Math.abs(a);
      b = Math.abs(b);
      while (b !== 0) {
        let t = b;
        b = a % b;
        a = t;
      }
      return a;
    }

    function lcm(a, b) {
      return Math.abs(a * b) / gcd(a, b);
    }

    function reduceFraction(num, den) {
      const g = gcd(num, den);
      return { num: num / g, den: den / g };
    }

    function formatFraction(num, den) {
      if (den === 1) return num.toString();
      return `${num}/${den}`;
    }

    function formatMixedNumber(whole, num, den) {
      if (whole === 0) return formatFraction(num, den);
      if (num === 0) return whole.toString();
      return `${whole} ${num}/${den}`;
    }

    function improperToMixed(num, den) {
      const whole = Math.floor(num / den);
      const remainder = num % den;
      return { whole, num: remainder, den };
    }

    function mixedToImproper(whole, num, den) {
      return { num: whole * den + num, den };
    }

    // Helper function to generate decimal number
    function generateDecimal(maxWhole, decimalPlaces) {
      const whole = Math.floor(Math.random() * maxWhole);
      // Limit to 1 decimal place maximum
      const actualPlaces = Math.min(decimalPlaces, 1);
      const decimal = Math.floor(Math.random() * Math.pow(10, actualPlaces));
      return parseFloat(whole + '.' + decimal.toString().padStart(actualPlaces, '0'));
    }

    // Helper function to format decimal with comma
    function formatDecimal(number) {
      return number.toString().replace('.', ',');
    }

    // Br√ºche exercise generators
    function generateFractionPartsExercise(difficulty) {
      // First exercise (index 0): Explanation page
      if (difficulty === 0) {
        return {
          isExplanation: true,
          tip: "Lies die Erkl√§rung aufmerksam durch. Auf der n√§chsten Seite gibt es eine Aufgabe dazu.",
          question: "Wie benennt man einen Bruch?"
        };
      }
      
      // All other exercises: Matching task
      return {
        isExplanation: false,
        num: 3,
        den: 4,
        tip: "√úberlege genau: Was steht oben, was in der Mitte, was unten?",
        question: "Ordne die drei Begriffe richtig zu:",
        solution: {
          top: "Z√§hler",
          middle: "Bruchstrich",
          bottom: "Nenner"
        }
      };
    }

    function generateFractionVisualExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      // Progressive denominators: start with 2-4, then add more complex ones
      const denominatorSets = [
        [2, 3, 4],           // Level 0: Halbe, Drittel, Viertel
        [2, 3, 4],           // Level 1: Same
        [3, 4, 5, 6],        // Level 2: Add fifths and sixths
        [4, 5, 6, 8],        // Level 3: Add eighths
        [5, 6, 8, 10],       // Level 4: Add tenths
        [6, 8, 10, 12],      // Level 5+: Most complex
      ];
      
      const availableDens = denominatorSets[Math.min(level, denominatorSets.length - 1)];
      const den = availableDens[Math.floor(Math.random() * availableDens.length)];
      const num = Math.floor(Math.random() * den) + 1;
      
      return {
        num: num,
        den: den,
        solution: { num, den },
        tip: "Z√§hle die eingef√§rbten Teile und die Gesamtanzahl der Teile.",
        question: `Welcher Bruch ist dargestellt?`,
        type: 'visual'
      };
    }

    function generateFractionTypesExercise(difficulty) {
      const fractions = [
        { num: 1, den: 3, type: 'proper' },
        { num: 2, den: 5, type: 'proper' },
        { num: 9, den: 10, type: 'proper' },
        { num: 9, den: 5, type: 'improper' },
        { num: 5, den: 3, type: 'improper' },
        { whole: 2, num: 7, den: 8, type: 'mixed' },
        { whole: 1, num: 1, den: 2, type: 'mixed' },
        { whole: 3, num: 2, den: 5, type: 'mixed' }
      ];
      
      // Shuffle and pick 6 fractions
      const shuffled = [...fractions].sort(() => Math.random() - 0.5).slice(0, 6);
      
      return {
        fractions: shuffled,
        tip: "Echter Bruch: Z√§hler < Nenner. Unechter Bruch: Z√§hler ‚â• Nenner. Gemischte Zahl: Ganze Zahl + Bruch.",
        question: `Ordne die Br√ºche zu (Ziehe sie in die richtige Kategorie):`,
        type: 'matching'
      };
    }

    function generateFractionExpandExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Progressive difficulty for denominators and expansion factors
      const denRanges = [
        { min: 2, max: 4 },   // Level 0-1: Small denominators
        { min: 2, max: 6 },   // Level 2-3: Medium denominators
        { min: 3, max: 8 },   // Level 4-5: Larger denominators
        { min: 4, max: 10 },  // Level 6-7: Even larger
        { min: 5, max: 12 },  // Level 8-9: Largest denominators
        { min: 5, max: 15 }   // Level 10+: Most complex
      ];
      
      const factorSets = [
        [2, 3],              // Level 0-1: Simple factors
        [2, 3, 4],           // Level 2-3: Add 4
        [3, 4, 5],           // Level 4-5: Medium factors
        [4, 5, 6],           // Level 6-7: Larger factors
        [5, 6, 7, 8],        // Level 8-9: Even larger
        [6, 7, 8, 9, 10]     // Level 10+: Largest factors
      ];
      
      const denRange = denRanges[Math.min(level, denRanges.length - 1)];
      const den = Math.floor(Math.random() * (denRange.max - denRange.min + 1)) + denRange.min;
      const num = Math.floor(Math.random() * (den - 1)) + 1;
      
      const availableFactors = factorSets[Math.min(level, factorSets.length - 1)];
      const factor = availableFactors[Math.floor(Math.random() * availableFactors.length)];
      
      return {
        num: num,
        den: den,
        factor: factor,
        solution: { num: num * factor, den: den * factor },
        tip: "Multipliziere Z√§hler und Nenner mit der gleichen Zahl.",
        question: `Erweitere den Bruch:`
      };
    }

    function generateFractionReduceExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Progressive difficulty for base fractions and factors
      const denRanges = [
        { min: 2, max: 4 },   // Level 0-1: Small base denominators
        { min: 2, max: 5 },   // Level 2-3: Medium
        { min: 3, max: 6 },   // Level 4-5: Larger
        { min: 3, max: 8 },   // Level 6-7: Even larger
        { min: 4, max: 10 },  // Level 8-9: Largest
        { min: 5, max: 12 }   // Level 10+: Most complex
      ];
      
      const factorSets = [
        [2, 3],              // Level 0-1: Simple factors
        [2, 3, 4],           // Level 2-3: Add 4
        [3, 4, 5],           // Level 4-5: Medium factors
        [4, 5, 6],           // Level 6-7: Larger factors
        [5, 6, 7],           // Level 8-9: Even larger
        [6, 7, 8, 9]         // Level 10+: Largest factors
      ];
      
      const denRange = denRanges[Math.min(level, denRanges.length - 1)];
      const baseDen = Math.floor(Math.random() * (denRange.max - denRange.min + 1)) + denRange.min;
      const baseNum = Math.floor(Math.random() * (baseDen - 1)) + 1;
      
      const availableFactors = factorSets[Math.min(level, factorSets.length - 1)];
      const factor = availableFactors[Math.floor(Math.random() * availableFactors.length)];
      
      const num = baseNum * factor;
      const den = baseDen * factor;
      const reduced = reduceFraction(num, den);
      
      return {
        num: num,
        den: den,
        solution: reduced,
        tip: "Finde den gr√∂√üten gemeinsamen Teiler (ggT) und dividiere Z√§hler und Nenner durch ihn.",
        question: `K√ºrze den Bruch so weit wie m√∂glich:`
      };
    }

    function generateFractionAddSameExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Progressive denominators
      const denSets = [
        [2, 3, 4],           // Level 0-1: Simple
        [3, 4, 5],           // Level 2-3: Medium
        [4, 5, 6],           // Level 4-5: Larger
        [5, 6, 8],           // Level 6-7: Even larger
        [6, 8, 10],          // Level 8-9: Largest
        [8, 10, 12]          // Level 10+: Most complex
      ];
      
      const availableDens = denSets[Math.min(level, denSets.length - 1)];
      const den = availableDens[Math.floor(Math.random() * availableDens.length)];
      
      // Ensure we can add without exceeding denominator
      const maxNum1 = Math.floor(den * 0.7);
      const num1 = Math.floor(Math.random() * maxNum1) + 1;
      const num2 = Math.floor(Math.random() * (den - num1));
      
      const resultNum = num1 + num2;
      const reduced = reduceFraction(resultNum, den);
      
      return {
        num1: num1,
        num2: num2,
        den: den,
        solution: reduced,
        tip: "Bei gleichem Nenner: Addiere die Z√§hler und behalte den Nenner. Dann k√ºrzen!",
        question: `Addiere und k√ºrze wenn m√∂glich:`
      };
    }

    function generateFractionSubtractSameExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Progressive denominators
      const denSets = [
        [2, 3, 4],           // Level 0-1: Simple
        [3, 4, 5],           // Level 2-3: Medium
        [4, 5, 6],           // Level 4-5: Larger
        [5, 6, 8],           // Level 6-7: Even larger
        [6, 8, 10],          // Level 8-9: Largest
        [8, 10, 12]          // Level 10+: Most complex
      ];
      
      const availableDens = denSets[Math.min(level, denSets.length - 1)];
      const den = availableDens[Math.floor(Math.random() * availableDens.length)];
      
      const num1 = Math.floor(Math.random() * (den - 1)) + 2;
      const num2 = Math.floor(Math.random() * num1) + 1;
      
      const resultNum = num1 - num2;
      const reduced = reduceFraction(resultNum, den);
      
      return {
        num1: num1,
        num2: num2,
        den: den,
        solution: reduced,
        tip: "Bei gleichem Nenner: Subtrahiere die Z√§hler und behalte den Nenner. Dann k√ºrzen!",
        question: `Subtrahiere und k√ºrze wenn m√∂glich:`
      };
    }

    function generateFractionAddDifferentExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Progressive denominator pairs (chosen to have manageable LCM)
      const denPairSets = [
        [[2, 4], [2, 6], [3, 6]],                    // Level 0-1: Very simple pairs
        [[2, 4], [3, 6], [4, 8]],                    // Level 2-3: Simple pairs
        [[2, 3], [3, 4], [4, 6], [3, 9]],           // Level 4-5: Medium pairs
        [[3, 5], [4, 6], [5, 10], [6, 9]],          // Level 6-7: More complex
        [[4, 6], [6, 8], [5, 15], [8, 12]],         // Level 8-9: Larger pairs
        [[6, 9], [8, 12], [10, 15], [12, 18]]       // Level 10+: Most complex
      ];
      
      const availablePairs = denPairSets[Math.min(level, denPairSets.length - 1)];
      const pair = availablePairs[Math.floor(Math.random() * availablePairs.length)];
      const den1 = pair[0];
      const den2 = pair[1];
      
      const num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
      const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
      
      const commonDen = lcm(den1, den2);
      const expandedNum1 = num1 * (commonDen / den1);
      const expandedNum2 = num2 * (commonDen / den2);
      const resultNum = expandedNum1 + expandedNum2;
      const reduced = reduceFraction(resultNum, commonDen);
      
      return {
        num1: num1,
        den1: den1,
        num2: num2,
        den2: den2,
        commonDen: commonDen,
        solution: reduced,
        steps: `${num1}/${den1} + ${num2}/${den2} = ${expandedNum1}/${commonDen} + ${expandedNum2}/${commonDen} = ${resultNum}/${commonDen} = ${formatFraction(reduced.num, reduced.den)}`,
        tip: "Finde den gemeinsamen Nenner (kgV), erweitere beide Br√ºche, dann addiere die Z√§hler.",
        question: `Addiere und k√ºrze wenn m√∂glich:`
      };
    }

    function generateFractionSubtractDifferentExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Progressive denominator pairs (chosen to have manageable LCM)
      const denPairSets = [
        [[2, 4], [2, 6], [3, 6]],                    // Level 0-1: Very simple pairs
        [[2, 4], [3, 6], [4, 8]],                    // Level 2-3: Simple pairs
        [[2, 3], [3, 4], [4, 6], [3, 9]],           // Level 4-5: Medium pairs
        [[3, 5], [4, 6], [5, 10], [6, 9]],          // Level 6-7: More complex
        [[4, 6], [6, 8], [5, 15], [8, 12]],         // Level 8-9: Larger pairs
        [[6, 9], [8, 12], [10, 15], [12, 18]]       // Level 10+: Most complex
      ];
      
      const availablePairs = denPairSets[Math.min(level, denPairSets.length - 1)];
      const pair = availablePairs[Math.floor(Math.random() * availablePairs.length)];
      let den1 = pair[0];
      let den2 = pair[1];
      
      let num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
      let num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
      
      const commonDen = lcm(den1, den2);
      let expandedNum1 = num1 * (commonDen / den1);
      let expandedNum2 = num2 * (commonDen / den2);
      
      // Ensure positive result by swapping if necessary
      if (expandedNum1 <= expandedNum2) {
        [num1, den1, num2, den2, expandedNum1, expandedNum2] = [num2, den2, num1, den1, expandedNum2, expandedNum1];
      }
      
      const resultNum = expandedNum1 - expandedNum2;
      const reduced = reduceFraction(resultNum, commonDen);
      
      return {
        num1: num1,
        den1: den1,
        num2: num2,
        den2: den2,
        commonDen: commonDen,
        solution: reduced,
        tip: "Finde den gemeinsamen Nenner (kgV), erweitere beide Br√ºche, dann subtrahiere die Z√§hler.",
        question: `Subtrahiere und k√ºrze wenn m√∂glich:`
      };
    }

    function generateFractionThreeOperationsExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const denoms = [2, 3, 4, 6];
      const den1 = denoms[Math.floor(Math.random() * denoms.length)];
      const den2 = denoms[Math.floor(Math.random() * denoms.length)];
      const den3 = denoms[Math.floor(Math.random() * denoms.length)];
      
      const num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
      const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
      const num3 = Math.floor(Math.random() * (den3 - 1)) + 1;
      
      const operation1 = Math.random() > 0.5 ? '+' : '-';
      const operation2 = Math.random() > 0.5 ? '+' : '-';
      
      const commonDen = lcm(lcm(den1, den2), den3);
      let result = (num1 * (commonDen / den1));
      
      if (operation1 === '+') {
        result += (num2 * (commonDen / den2));
      } else {
        result -= (num2 * (commonDen / den2));
      }
      
      if (operation2 === '+') {
        result += (num3 * (commonDen / den3));
      } else {
        result -= (num3 * (commonDen / den3));
      }
      
      const reduced = result > 0 ? reduceFraction(Math.abs(result), commonDen) : { num: 0, den: 1 };
      
      return {
        num1, den1, num2, den2, num3, den3,
        operation1, operation2,
        commonDen: commonDen,
        solution: reduced,
        tip: "Bringe alle drei Br√ºche auf den gleichen Nenner, dann f√ºhre die Operationen von links nach rechts aus.",
        question: `Berechne und k√ºrze wenn mÔøΩÔøΩÔøΩÔøΩglich:`
      };
    }

    function generateFractionToDecimalExercise(difficulty) {
      const commonFractions = [
        { num: 1, den: 2, decimal: 0.5 },
        { num: 1, den: 4, decimal: 0.25 },
        { num: 3, den: 4, decimal: 0.75 },
        { num: 1, den: 5, decimal: 0.2 },
        { num: 2, den: 5, decimal: 0.4 },
        { num: 3, den: 5, decimal: 0.6 },
        { num: 4, den: 5, decimal: 0.8 },
        { num: 1, den: 8, decimal: 0.125 },
        { num: 3, den: 8, decimal: 0.375 },
        { num: 1, den: 10, decimal: 0.1 },
        { num: 3, den: 10, decimal: 0.3 },
        { num: 7, den: 10, decimal: 0.7 }
      ];
      
      const fraction = commonFractions[Math.floor(Math.random() * commonFractions.length)];
      
      return {
        num: fraction.num,
        den: fraction.den,
        solution: fraction.decimal,
        tip: "Dividiere den Z√§hler durch den Nenner.",
        question: `Wandle den Bruch in eine Dezimalzahl um:`
      };
    }

    function generateDecimalToFractionExercise(difficulty) {
      const commonDecimals = [
        { decimal: 0.5, num: 1, den: 2 },
        { decimal: 0.25, num: 1, den: 4 },
        { decimal: 0.75, num: 3, den: 4 },
        { decimal: 0.2, num: 1, den: 5 },
        { decimal: 0.4, num: 2, den: 5 },
        { decimal: 0.6, num: 3, den: 5 },
        { decimal: 0.8, num: 4, den: 5 },
        { decimal: 0.1, num: 1, den: 10 },
        { decimal: 0.3, num: 3, den: 10 },
        { decimal: 0.7, num: 7, den: 10 }
      ];
      
      const item = commonDecimals[Math.floor(Math.random() * commonDecimals.length)];
      
      return {
        decimal: item.decimal,
        solution: { num: item.num, den: item.den },
        tip: "Schreibe die Dezimalzahl als Bruch (z.B. 0,5 = 5/10) und k√ºrze.",
        question: `Wandle die Dezimalzahl in einen Bruch um:`
      };
    }

    function generateMixedToImproperExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const whole = Math.floor(Math.random() * 5) + 1;
      const den = Math.floor(Math.random() * 6) + 2;
      const num = Math.floor(Math.random() * (den - 1)) + 1;
      
      const improper = mixedToImproper(whole, num, den);
      
      return {
        whole: whole,
        num: num,
        den: den,
        solution: improper,
        tip: "Multipliziere die ganze Zahl mit dem Nenner, addiere den Z√§hler. Das Ergebnis ist der neue Z√§hler.",
        question: `Wandle die gemischte Zahl in einen unechten Bruch um:`
      };
    }

    function generateMixedAdditionExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const whole1 = Math.floor(Math.random() * 4) + 1;
      const whole2 = Math.floor(Math.random() * 3) + 1;
      const den = [2, 3, 4, 6][Math.floor(Math.random() * 4)];
      const num1 = Math.floor(Math.random() * den);
      const num2 = Math.floor(Math.random() * den);
      
      const totalWhole = whole1 + whole2;
      const totalNum = num1 + num2;
      let finalWhole = totalWhole + Math.floor(totalNum / den);
      let finalNum = totalNum % den;
      
      const reduced = finalNum > 0 ? reduceFraction(finalNum, den) : { num: 0, den: 1 };
      
      return {
        whole1, num1, den1: den,
        whole2, num2, den2: den,
        solution: { whole: finalWhole, num: reduced.num, den: reduced.den },
        tip: "Addiere die ganzen Zahlen und die Br√ºche separat. Wenn der Bruch > 1, wandle in gemischte Zahl um.",
        question: `Addiere die gemischten Zahlen:`
      };
    }

    function generateMixedSubtractionExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const whole1 = Math.floor(Math.random() * 4) + 3;
      const whole2 = Math.floor(Math.random() * (whole1 - 1)) + 1;
      const den = [2, 3, 4, 6][Math.floor(Math.random() * 4)];
      const num1 = Math.floor(Math.random() * den);
      const num2 = Math.floor(Math.random() * den);
      
      return {
        whole1, num1, den1: den,
        whole2, num2, den2: den,
        tip: "Subtrahiere die ganzen Zahlen und die Br√ºche separat. Bei Bedarf 'leihen' von der ganzen Zahl.",
        question: `Subtrahiere die gemischten Zahlen:`
      };
    }

    function generateFractionMultiplyExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Progressive denominators
      const denRanges = [
        { min: 2, max: 4 },   // Level 0-1: Small denominators
        { min: 2, max: 5 },   // Level 2-3: Medium
        { min: 3, max: 6 },   // Level 4-5: Larger
        { min: 3, max: 8 },   // Level 6-7: Even larger
        { min: 4, max: 10 },  // Level 8-9: Largest
        { min: 5, max: 12 }   // Level 10+: Most complex
      ];
      
      const denRange = denRanges[Math.min(level, denRanges.length - 1)];
      const den1 = Math.floor(Math.random() * (denRange.max - denRange.min + 1)) + denRange.min;
      const den2 = Math.floor(Math.random() * (denRange.max - denRange.min + 1)) + denRange.min;
      const num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
      const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
      
      const resultNum = num1 * num2;
      const resultDen = den1 * den2;
      const reduced = reduceFraction(resultNum, resultDen);
      
      return {
        num1, den1, num2, den2,
        solution: reduced,
        tip: "Multipliziere Z√§hler mit Z√§hler und Nenner mit Nenner. Dann k√ºrzen!",
        question: `Multipliziere die Br√ºche:`
      };
    }

    function generateFractionMultiplyNaturalExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const natural = Math.floor(Math.random() * 8) + 2;
      const den = Math.floor(Math.random() * 6) + 2;
      const num = Math.floor(Math.random() * (den - 1)) + 1;
      
      const resultNum = num * natural;
      const reduced = reduceFraction(resultNum, den);
      const mixed = improperToMixed(reduced.num, reduced.den);
      
      return {
        num, den, natural,
        solution: mixed.whole > 0 ? mixed : reduced,
        tip: "Multipliziere die nat√ºrliche Zahl mit dem Z√§hler. Der Nenner bleibt gleich.",
        question: `Multipliziere:`
      };
    }

    function generateMixedMultiplyExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const whole1 = Math.floor(Math.random() * 3) + 1;
      const den1 = [2, 3, 4, 5][Math.floor(Math.random() * 4)];
      const num1 = Math.floor(Math.random() * den1);
      
      const den2 = [2, 3, 4, 5][Math.floor(Math.random() * 4)];
      const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
      
      const imp1 = mixedToImproper(whole1, num1, den1);
      const resultNum = imp1.num * num2;
      const resultDen = imp1.den * den2;
      const reduced = reduceFraction(resultNum, resultDen);
      
      return {
        whole1, num1, den1, num2, den2,
        solution: reduced,
        tip: "Wandle die gemischte Zahl in einen unechten Bruch um, dann multipliziere.",
        question: `Multipliziere:`
      };
    }

    function generateFractionReciprocalExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Mix of proper fractions, improper fractions, and natural numbers
      const types = ['proper', 'improper', 'natural'];
      const type = types[Math.floor(Math.random() * types.length)];
      
      let num, den, reciprocalNum, reciprocalDen;
      
      if (type === 'natural') {
        num = Math.floor(Math.random() * 8) + 2;
        den = 1;
        reciprocalNum = 1;
        reciprocalDen = num;
      } else if (type === 'proper') {
        den = Math.floor(Math.random() * 8) + 2;
        num = Math.floor(Math.random() * (den - 1)) + 1;
        reciprocalNum = den;
        reciprocalDen = num;
      } else {
        den = Math.floor(Math.random() * 6) + 2;
        num = den + Math.floor(Math.random() * den) + 1;
        reciprocalNum = den;
        reciprocalDen = num;
      }
      
      return {
        num, den,
        solution: { num: reciprocalNum, den: reciprocalDen },
        tip: "Der Kehrwert entsteht, indem Z√§hler und Nenner vertauscht werden.",
        question: `Bilde den Kehrwert:`
      };
    }

    function generateFractionDivideExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Progressive denominators
      const denRanges = [
        { min: 2, max: 4 },   // Level 0-1: Small denominators
        { min: 2, max: 5 },   // Level 2-3: Medium
        { min: 3, max: 6 },   // Level 4-5: Larger
        { min: 3, max: 8 },   // Level 6-7: Even larger
        { min: 4, max: 10 },  // Level 8-9: Largest
        { min: 5, max: 12 }   // Level 10+: Most complex
      ];
      
      const denRange = denRanges[Math.min(level, denRanges.length - 1)];
      const den1 = Math.floor(Math.random() * (denRange.max - denRange.min + 1)) + denRange.min;
      const den2 = Math.floor(Math.random() * (denRange.max - denRange.min + 1)) + denRange.min;
      const num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
      const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
      
      const resultNum = num1 * den2;
      const resultDen = den1 * num2;
      const reduced = reduceFraction(resultNum, resultDen);
      
      return {
        num1, den1, num2, den2,
        solution: reduced,
        tip: "Dividieren = Multiplizieren mit dem Kehrwert. Drehe den zweiten Bruch um und multipliziere.",
        question: `Dividiere die Br√ºche:`
      };
    }

    function generateFractionDivideNaturalExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const natural = Math.floor(Math.random() * 6) + 2;
      const den = Math.floor(Math.random() * 6) + 2;
      const num = Math.floor(Math.random() * (den * natural));
      
      const resultNum = num;
      const resultDen = den * natural;
      const reduced = reduceFraction(resultNum, resultDen);
      
      return {
        num, den, natural,
        solution: reduced,
        tip: "Dividieren durch eine nat√ºrliche Zahl = Multiplizieren des Nenners mit dieser Zahl.",
        question: `Dividiere:`
      };
    }

    function generateMixedDivideExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const whole1 = Math.floor(Math.random() * 3) + 1;
      const den1 = [2, 3, 4][Math.floor(Math.random() * 3)];
      const num1 = Math.floor(Math.random() * den1);
      
      const den2 = [2, 3, 4][Math.floor(Math.random() * 3)];
      const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
      
      const imp1 = mixedToImproper(whole1, num1, den1);
      const resultNum = imp1.num * den2;
      const resultDen = imp1.den * num2;
      const reduced = reduceFraction(resultNum, resultDen);
      
      return {
        whole1, num1, den1, num2, den2,
        solution: reduced,
        tip: "Wandle gemischte Zahlen in unechte Br√ºche um, dann dividiere (= mit Kehrwert multiplizieren).",
        question: `Dividiere:`
      };
    }

    function generateFractionOrderExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const whole = Math.floor(Math.random() * 4) + 1;
      const den1 = [2, 3, 4][Math.floor(Math.random() * 3)];
      const num1 = Math.floor(Math.random() * den1);
      const den2 = [3, 4, 5][Math.floor(Math.random() * 3)];
      const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
      const den3 = [2, 4][Math.floor(Math.random() * 2)];
      const num3 = Math.floor(Math.random() * (den3 - 1)) + 1;
      
      // Expression: whole num1/den1 + num2/den2 * num3/den3
      const multiplyResult = (num2 * num3) / (den2 * den3);
      const addFraction = num1 / den1;
      const finalResult = whole + addFraction + multiplyResult;
      
      return {
        whole, num1, den1, num2, den2, num3, den3,
        tip: "Punkt vor Strich! Erst multiplizieren/dividieren, dann addieren/subtrahieren.",
        question: `Berechne (beachte Vorrangregeln):`
      };
    }

    function generateFractionWordProblemExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      const problems = [
        {
          generate: () => {
            const total = [20, 24, 30, 36][Math.floor(Math.random() * 4)];
            const fractionGirls = [3, 4][Math.floor(Math.random() * 2)];
            const girls = total * fractionGirls / 5;
            const boys = total - girls;
            return {
              text: `Ein Schulchor besteht aus ${fractionGirls}/5 M√§dchen und ${5 - fractionGirls}/5 Jungen. Wenn der Chor aus ${total} Kindern besteht, wie viele M√§dchen und wie viele Jungen singen im Chor?`,
              solution: { girls, boys },
              tip: `Multipliziere den Bruch mit der Gesamtzahl: ${fractionGirls}/5 von ${total} = ${fractionGirls}/5 ¬∑ ${total}`
            };
          }
        },
        {
          generate: () => {
            const total = [24, 36, 48][Math.floor(Math.random() * 3)];
            const fraction = [1, 2][Math.floor(Math.random() * 2)];
            const den = [3, 4][Math.floor(Math.random() * 2)];
            const part = total * fraction / den;
            return {
              text: `Lisa hat ${total} ‚Ç¨ gespart. Sie gibt ${fraction}/${den} ihres Geldes f√ºr ein Buch aus. Wie viel Geld hat sie ausgegeben?`,
              solution: { amount: part },
              tip: `Berechne ${fraction}/${den} von ${total}: ${fraction}/${den} ¬∑ ${total}`
            };
          }
        },
        {
          generate: () => {
            const pizzas = [2, 3, 4][Math.floor(Math.random() * 3)];
            const people = [4, 6, 8][Math.floor(Math.random() * 3)];
            const reduced = reduceFraction(pizzas, people);
            return {
              text: `${pizzas} Pizzen werden gleichm√§√üig auf ${people} Personen aufgeteilt. Wie viel Pizza bekommt jede Person?`,
              solution: { num: reduced.num, den: reduced.den },
              tip: `Teile die Pizzen durch die Anzahl der Personen: ${pizzas}/${people}`
            };
          }
        }
      ];
      
      const problem = problems[Math.floor(Math.random() * problems.length)].generate();
      
      return {
        problem: problem.text,
        solution: problem.solution,
        tip: problem.tip,
        question: `L√∂se die Textaufgabe:`
      };
    }

    // Gleichungen exercise generators
    function generateOneStepEquationExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(20 + (level * 10), 100);
      
      const types = ['addition', 'subtraction', 'multiplication', 'division'];
      const type = types[Math.floor(Math.random() * types.length)];
      let equation, solution, steps, proof;
      
      switch(type) {
        case 'addition':
          const a1 = Math.floor(Math.random() * maxNum) + 1;
          const b1 = Math.floor(Math.random() * maxNum) + a1;
          solution = b1 - a1;
          equation = `x + ${a1} = ${b1}`;
          steps = `x + ${a1} = ${b1}     | -${a1}\nx = ${b1} - ${a1}\nx = ${solution}`;
          proof = `Probe:\n${solution} + ${a1} = ${b1}\n${b1} = ${b1} ‚úì`;
          break;
          
        case 'subtraction':
          const a2 = Math.floor(Math.random() * maxNum) + 1;
          const sol2 = Math.floor(Math.random() * maxNum) + a2;
          const b2 = sol2 - a2;
          solution = sol2;
          equation = `x - ${a2} = ${b2}`;
          steps = `x - ${a2} = ${b2}     | +${a2}\nx = ${b2} + ${a2}\nx = ${solution}`;
          proof = `Probe:\n${solution} - ${a2} = ${b2}\n${b2} = ${b2} ‚úì`;
          break;
          
        case 'multiplication':
          const a3 = Math.floor(Math.random() * 10) + 2;
          const sol3 = Math.floor(Math.random() * (maxNum / a3)) + 1;
          const b3 = a3 * sol3;
          solution = sol3;
          equation = `${a3}x = ${b3}`;
          steps = `${a3}x = ${b3}     | :${a3}\nx = ${b3} : ${a3}\nx = ${solution}`;
          proof = `Probe:\n${a3} ¬∑ ${solution} = ${b3}\n${b3} = ${b3} ‚úì`;
          break;
          
        case 'division':
          const a4 = Math.floor(Math.random() * 10) + 2;
          const sol4 = (Math.floor(Math.random() * 20) + 1) * a4;
          solution = sol4;
          equation = `x/${a4} = ${sol4 / a4}`;
          steps = `x/${a4} = ${sol4 / a4}     | ¬∑${a4}\nx = ${sol4 / a4} ¬∑ ${a4}\nx = ${solution}`;
          proof = `Probe:\n${solution}/${a4} = ${sol4 / a4}\n${sol4 / a4} = ${sol4 / a4} ÔøΩÔøΩÔøΩ`;
          break;
      }
      
      return {
        equation: equation,
        solution: solution,
        steps: steps,
        proof: proof,
        tip: "F√ºhre die Umkehroperation durch: Bei +a ziehe -a, bei -a addiere +a, bei √óa dividiere durch a, bei /a multipliziere mit a.",
        question: `L√∂se die Gleichung:`
      };
    }

    function generateSimpleMultiStepEquationExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(15 + (level * 5), 50);
      
      // Form: ax + b = c oder ax - b = c
      const a = Math.floor(Math.random() * 8) + 2;
      const b = Math.floor(Math.random() * maxNum) + 1;
      const xVal = Math.floor(Math.random() * 15) + 1;
      
      const useAddition = Math.random() > 0.5;
      let equation, solution, steps, proof, c;
      
      if (useAddition) {
        c = a * xVal + b;
        solution = xVal;
        equation = `${a}x + ${b} = ${c}`;
        steps = `${a}x + ${b} = ${c}     | -${b}\n${a}x = ${c - b}     | :${a}\nx = ${(c - b) / a}\nx = ${solution}`;
        proof = `Probe:\n${a} ¬∑ ${solution} + ${b} = ${c}\n${a * solution} + ${b} = ${c}\n${c} = ${c} ‚úì`;
      } else {
        c = a * xVal - b;
        solution = xVal;
        equation = `${a}x - ${b} = ${c}`;
        steps = `${a}x - ${b} = ${c}     | +${b}\n${a}x = ${c + b}     | :${a}\nx = ${(c + b) / a}\nx = ${solution}`;
        proof = `Probe:\n${a} ¬∑ ${solution} - ${b} = ${c}\n${a * solution} - ${b} = ${c}\n${c} = ${c} ‚úì`;
      }
      
      return {
        equation: equation,
        solution: solution,
        steps: steps,
        proof: proof,
        tip: "L√∂se zuerst die Addition/Subtraktion, dann die Multiplikation/Division. Arbeite von au√üen nach innen zu x.",
        question: `L√∂se die Gleichung:`
      };
    }

    function generateComplexMultiStepEquationExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(10 + (level * 5), 40);
      
      // Form: ax + b = c - dx  (Variable auf beiden Seiten)
      const a = Math.floor(Math.random() * 6) + 2;
      const d = Math.floor(Math.random() * 5) + 1;
      const b = Math.floor(Math.random() * maxNum) + 1;
      const xVal = Math.floor(Math.random() * 10) + 1;
      const c = a * xVal + b + d * xVal;
      
      const solution = xVal;
      const equation = `${a}x + ${b} = ${c} - ${d}x`;
      
      const steps = `${a}x + ${b} = ${c} - ${d}x     | +${d}x
${a + d}x + ${b} = ${c}     | -${b}
${a + d}x = ${c - b}     | :${a + d}
x = ${(c - b) / (a + d)}
x = ${solution}`;

      const leftSide = a * solution + b;
      const rightSide = c - d * solution;
      const proof = `Probe:
${a} ¬∑ ${solution} + ${b} = ${c} - ${d} ¬∑ ${solution}
${a * solution} + ${b} = ${c} - ${d * solution}
${leftSide} = ${rightSide} ‚úì`;
      
      return {
        equation: equation,
        solution: solution,
        steps: steps,
        proof: proof,
        tip: "Bringe alle x-Terme auf eine Seite und alle Zahlen auf die andere Seite. Dann l√∂se wie gewohnt.",
        question: `L√∂se die Gleichung:`
      };
    }

    function generateEquationProofExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(15 + (level * 5), 50);
      
      // Verschiedene Gleichungstypen f√ºr die Probe
      const types = ['simple_multi', 'with_variable_both_sides'];
      const type = types[Math.floor(Math.random() * types.length)];
      
      let equation, solution, steps, proof;
      
      if (type === 'simple_multi') {
        const a = Math.floor(Math.random() * 7) + 2;
        const b = Math.floor(Math.random() * maxNum) + 1;
        const xVal = Math.floor(Math.random() * 12) + 1;
        const c = a * xVal + b;
        
        solution = xVal;
        equation = `${a}x + ${b} = ${c}`;
        steps = `${a}x + ${b} = ${c}     | -${b}\n${a}x = ${c - b}     | :${a}\nx = ${(c - b) / a}\nx = ${solution}`;
        proof = `Probe:\n${a} ¬∑ ${solution} + ${b} = ${c}\n${a * solution} + ${b} = ${c}\n${c} = ${c} ÔøΩÔøΩÔøΩ`;
      } else {
        const a = Math.floor(Math.random() * 5) + 2;
        const d = Math.floor(Math.random() * 4) + 1;
        const b = Math.floor(Math.random() * 20) + 1;
        const xVal = Math.floor(Math.random() * 8) + 1;
        const c = a * xVal + b + d * xVal;
        
        solution = xVal;
        equation = `${a}x + ${b} = ${c} - ${d}x`;
        steps = `${a}x + ${b} = ${c} - ${d}x     | +${d}x\n${a + d}x + ${b} = ${c}     | -${b}\n${a + d}x = ${c - b}     | :${a + d}\nx = ${solution}`;
        
        const leftSide = a * solution + b;
        const rightSide = c - d * solution;
        proof = `Probe:\n${a} ¬∑ ${solution} + ${b} = ${c} - ${d} ¬∑ ${solution}\n${leftSide} = ${rightSide} ‚úì`;
      }
      
      return {
        equation: equation,
        solution: solution,
        steps: steps,
        proof: proof,
        tip: "L√∂se zuerst die Gleichung, dann setze deine L√∂sung in die urspr√ºngliche Gleichung ein und pr√ºfe, ob beide Seiten gleich sind.",
        question: `L√∂se die Gleichung und f√ºhre die Probe durch:`
      };
    }

    function generateQuadraticEquationExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      
      // Einfache quadratische Gleichungen, die aufgehen
      // Form: 4x(x-5) = 4x¬≤ + 4x + 48
      const types = ['expandable'];
      
      const a = Math.floor(Math.random() * 5) + 2;
      const b = Math.floor(Math.random() * 8) + 1;
      const c = Math.floor(Math.random() * 10) + 1;
      const xVal = Math.floor(Math.random() * 15) + 5;
      
      // Erstelle Gleichung die linear wird nach Vereinfachung
      const right = a * xVal * xVal + c * xVal + b * xVal * (xVal - a);
      
      const solution = xVal;
      const equation = `${a}x(x - ${a}) = ${a}x¬≤ + ${c}x + ${b * xVal * (xVal - a)}`;
      
      const steps = `${a}x(x - ${a}) = ${a}x¬≤ + ${c}x + ${b * xVal * (xVal - a)}
${a}x¬≤ - ${a * a}x = ${a}x¬≤ + ${c}x + ${b * xVal * (xVal - a)}     | -${a}x¬≤
-${a * a}x = ${c}x + ${b * xVal * (xVal - a)}     | -${c}x
-${a * a + c}x = ${b * xVal * (xVal - a)}     | :(-${a * a + c})
x = ${solution}`;

      const leftCalc = a * solution * (solution - a);
      const rightCalc = a * solution * solution + c * solution + b * xVal * (xVal - a);
      const proof = `Probe:
${a} ¬∑ ${solution} ¬∑ (${solution} - ${a}) = ${a} ¬∑ ${solution}¬≤ + ${c} ¬∑ ${solution} + ${b * xVal * (xVal - a)}
${leftCalc} = ${rightCalc} ‚úì`;
      
      return {
        equation: equation,
        solution: solution,
        steps: steps,
        proof: proof,
        tip: "L√∂se die Klammern auf beiden Seiten auf, vereinfache und bringe alle x-Terme auf eine Seite.",
        question: `L√∂se die quadratische Gleichung:`
      };
    }

    function generateTextEquationExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(30 + (level * 10), 100);
      
      const wordProblems = [
        {
          generate: () => {
            const x = Math.floor(Math.random() * maxNum) + 12;
            const result = Math.floor(x / 3 - x / 4);
            return { 
              x, 
              text: `Subtrahiert man vom Drittel einer Zahl ein Viertel dieser Zahl, so ergibt sich ${result}.`,
              equation: `x/3 - x/4 = ${result}`,
              steps: `x/3 - x/4 = ${result}     | ¬∑12
4x - 3x = ${result * 12}
x = ${x}`,
              proof: `Probe:
${x}/3 - ${x}/4 = ${result}
${x / 3} - ${x / 4} = ${result}
${result} = ${result} ‚úì`
            };
          }
        },
        {
          generate: () => {
            const x = Math.floor(Math.random() * 50) + 20;
            const result = Math.floor(x / 2 + 7);
            return {
              x,
              text: `Addiert man zur H√§lfte einer Zahl 7, so erh√§lt man ${result}.`,
              equation: `x/2 + 7 = ${result}`,
              steps: `x/2 + 7 = ${result}     | -7
x/2 = ${result - 7}     | ¬∑2
x = ${x}`,
              proof: `Probe:
${x}/2 + 7 = ${result}
${x / 2} + 7 = ${result}
${result} = ${result} ‚úì`
            };
          }
        },
        {
          generate: () => {
            const x = Math.floor(Math.random() * 40) + 15;
            const factor = Math.floor(Math.random() * 4) + 3;
            const subtract = Math.floor(Math.random() * 15) + 5;
            const result = factor * x - subtract;
            return {
              x,
              text: `Das ${factor}-fache einer Zahl vermindert um ${subtract} ergibt ${result}.`,
              equation: `${factor}x - ${subtract} = ${result}`,
              steps: `${factor}x - ${subtract} = ${result}     | +${subtract}
${factor}x = ${result + subtract}     | :${factor}
x = ${x}`,
              proof: `Probe:
${factor} ¬∑ ${x} - ${subtract} = ${result}
${factor * x} - ${subtract} = ${result}
${result} = ${result} ‚úì`
            };
          }
        }
      ];
      
      const problem = wordProblems[Math.floor(Math.random() * wordProblems.length)].generate();
      
      return {
        wordProblem: problem.text,
        equation: problem.equation,
        solution: problem.x,
        steps: problem.steps,
        proof: problem.proof,
        tip: "Lies die Aufgabe genau. √úbersetze die Worte in mathematische Symbole und stelle eine Gleichung auf.",
        question: `Stelle eine Gleichung auf, l√∂se sie und mache die Probe:`
      };
    }

    function generateBracketEquationExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(15 + (level * 5), 50);
      
      const types = ['simple_bracket', 'double_bracket'];
      const type = types[Math.floor(Math.random() * types.length)];
      
      let equation, solution, steps;
      
      if (type === 'simple_bracket') {
        // Form: a(x + b) = c
        const a = Math.floor(Math.random() * 5) + 2;
        const b = Math.floor(Math.random() * maxNum) + 1;
        const xVal = Math.floor(Math.random() * 20) + 1;
        const c = a * (xVal + b);
        solution = xVal;
        equation = `${a}(x + ${b}) = ${c}`;
        steps = `${a}(x + ${b}) = ${c}\nx + ${b} = ${c / a}\nx = ${c / a} - ${b}\nx = ${solution}`;
      } else {
        // Form: a(x + b) + c = d
        const a = Math.floor(Math.random() * 4) + 2;
        const b = Math.floor(Math.random() * 10) + 1;
        const c = Math.floor(Math.random() * 20) + 1;
        const xVal = Math.floor(Math.random() * 15) + 1;
        const d = a * (xVal + b) + c;
        solution = xVal;
        equation = `${a}(x + ${b}) + ${c} = ${d}`;
        steps = `${a}(x + ${b}) + ${c} = ${d}\n${a}(x + ${b}) = ${d - c}\nx + ${b} = ${(d - c) / a}\nx = ${(d - c) / a} - ${b}\nx = ${solution}`;
      }
      
      return {
        equation: equation,
        solution: solution,
        steps: steps,
        tip: "L√∂se zuerst die Klammer auf oder dividiere beide Seiten durch den Faktor vor der Klammer.",
        question: `L√∂se die Gleichung nach x auf:`
      };
    }

    function generateFractionEquationExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(20 + (level * 10), 100);
      
      const types = ['simple_fraction', 'fraction_with_number'];
      const type = types[Math.floor(Math.random() * types.length)];
      
      let equation, solution, steps;
      
      if (type === 'simple_fraction') {
        // Form: x/a = b
        const a = Math.floor(Math.random() * 8) + 2;
        const b = Math.floor(Math.random() * (maxNum / a)) + 1;
        solution = a * b;
        equation = `x/${a} = ${b}`;
        steps = `x/${a} = ${b}\nx = ${b} ¬∑ ${a}\nx = ${solution}`;
      } else {
        // Form: x/a + b = c
        const a = Math.floor(Math.random() * 6) + 2;
        const b = Math.floor(Math.random() * 15) + 1;
        const xVal = Math.floor(Math.random() * 30) + a;
        const c = (xVal / a) + b;
        solution = xVal;
        equation = `x/${a} + ${b} = ${c}`;
        steps = `x/${a} + ${b} = ${c}\nx/${a} = ${c - b}\nx = ${c - b} ¬∑ ${a}\nx = ${solution}`;
      }
      
      return {
        equation: equation,
        solution: solution,
        steps: steps,
        tip: "Multipliziere beide Seiten mit dem Nenner, um den Bruch aufzul√∂sen.",
        question: `L√∂se die Gleichung nach x auf:`
      };
    }

    function generateWordEquationExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(50 + (level * 20), 200);
      
      const wordProblems = [
        {
          text: (n1, n2, result) => `Wenn ich zu einer Zahl ${n1} addiere und dann ${n2} abziehe, erhalte ich ${result}. Wie lautet die Zahl?`,
          generate: () => {
            const x = Math.floor(Math.random() * maxNum) + 10;
            const n1 = Math.floor(Math.random() * 20) + 5;
            const n2 = Math.floor(Math.random() * 15) + 3;
            const result = x + n1 - n2;
            return { 
              x, 
              text: `Wenn ich zu einer Zahl ${n1} addiere und dann ${n2} abziehe, erhalte ich ${result}. Wie lautet die Zahl?`,
              equation: `x + ${n1} - ${n2} = ${result}`,
              steps: `x + ${n1} - ${n2} = ${result}\nx = ${result} - ${n1} + ${n2}\nx = ${x}`
            };
          }
        },
        {
          text: (factor, result) => `Das ${factor}-fache einer Zahl ist ${result}. Wie lautet die Zahl?`,
          generate: () => {
            const factor = Math.floor(Math.random() * 8) + 3;
            const x = Math.floor(Math.random() * (maxNum / factor)) + 5;
            const result = factor * x;
            return {
              x,
              text: `Das ${factor}-fache einer Zahl ist ${result}. Wie lautet die Zahl?`,
              equation: `${factor} ¬∑ x = ${result}`,
              steps: `${factor} ¬∑ x = ${result}\nx = ${result} : ${factor}\nx = ${x}`
            };
          }
        },
        {
          text: (n1, result) => `Wenn ich eine Zahl halbiere und dann ${n1} addiere, erhalte ich ${result}. Wie lautet die Zahl?`,
          generate: () => {
            const n1 = Math.floor(Math.random() * 20) + 5;
            const x = (Math.floor(Math.random() * 30) + 10) * 2;
            const result = (x / 2) + n1;
            return {
              x,
              text: `Wenn ich eine Zahl halbiere und dann ${n1} addiere, erhalte ich ${result}. Wie lautet die Zahl?`,
              equation: `x/2 + ${n1} = ${result}`,
              steps: `x/2 + ${n1} = ${result}\nx/2 = ${result - n1}\nx = ${(result - n1) * 2}\nx = ${x}`
            };
          }
        },
        {
          text: (price, discount, final) => `Ein Artikel kostet ${price}ÔøΩÔøΩÔøΩÔøΩÔøΩ. Nach einem Rabatt von ${discount}‚Ç¨ zahle ich ${final}‚Ç¨. War das richtig?`,
          generate: () => {
            const price = Math.floor(Math.random() * 100) + 50;
            const discount = Math.floor(Math.random() * 30) + 10;
            const final = price - discount;
            return {
              x: price,
              text: `Ein Artikel kostet x‚Ç¨. Nach einem Rabatt von ${discount}‚Ç¨ zahle ich ${final}‚Ç¨. Wie viel kostete der Artikel urspr√ºnglich?`,
              equation: `x - ${discount} = ${final}`,
              steps: `x - ${discount} = ${final}\nx = ${final} + ${discount}\nx = ${price}`
            };
          }
        },
        {
          text: (students, perGroup, groups) => `${students} Sch√ºler werden in Gruppen zu je ${perGroup} aufgeteilt. Es gibt ${groups} Gruppen. Stimmt das?`,
          generate: () => {
            const perGroup = Math.floor(Math.random() * 5) + 3;
            const groups = Math.floor(Math.random() * 8) + 3;
            const students = perGroup * groups;
            return {
              x: students,
              text: `x Sch√ºler werden in Gruppen zu je ${perGroup} aufgeteilt. Es gibt ${groups} Gruppen. Wie viele Sch√ºler sind es insgesamt?`,
              equation: `x/${perGroup} = ${groups}`,
              steps: `x/${perGroup} = ${groups}\nx = ${groups} ¬∑ ${perGroup}\nx = ${students}`
            };
          }
        }
      ];
      
      const problem = wordProblems[Math.floor(Math.random() * wordProblems.length)].generate();
      
      return {
        wordProblem: problem.text,
        equation: problem.equation,
        solution: problem.x,
        steps: problem.steps,
        tip: "Lies die Aufgabe genau. √úberlege, welche mathematische Operation beschrieben wird, und stelle eine Gleichung auf.",
        question: `L√∂se die Textaufgabe:`
      };
    }

    // Natural number exercise generators
    function generateOrderingExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const count = Math.min(4 + level, 10);
      const maxNum = Math.min(1000 * Math.pow(10, level), 9999999);
      const numbers = [];
      
      for (let i = 0; i < count; i++) {
        numbers.push(Math.floor(Math.random() * maxNum) + 1);
      }
      
      return {
        numbers: numbers,
        solution: [...numbers].sort((a, b) => a - b),
        tip: "Vergleiche die Zahlen Ziffer f√ºr Ziffer von links nach rechts. Die Zahl mit der gr√∂√üeren Ziffer an der gleichen Stelle ist gr√∂√üer.",
        question: `Ordne die Zahlen von der kleinsten bis zur gr√∂√üten. Verwende dabei das richtige Zeichen &lt;, &gt; oder =.`
      };
    }

    function generatePredecessorExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(1000 * Math.pow(10, level), 99999999);
      const number = Math.floor(Math.random() * (maxNum - 2)) + 2;
      
      return {
        number: number,
        predecessor: number - 1,
        successor: number + 1,
        tip: "Der Vorg√§nger ist die Zahl minus 1, der Nachfolger ist die Zahl plus 1.",
        question: `Nenne den Vorg√§nger und den Nachfolger:`
      };
    }

    function generateStellenwertExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const digitCount = Math.min(3 + level, 7);
      const maxNum = Math.pow(10, digitCount) - 1;
      const number = Math.floor(Math.random() * maxNum) + 1;
      
      return {
        number: number,
        tip: "Jede Stelle hat einen bestimmten Wert: E (Einer), Z (Zehner), H (Hunderter), T (Tausender), ZT (Zehntausender), HT (Hunderttausender), M (Millionen)",
        question: `Trage diese Zahl in die Stellenwerttabelle ein:`
      };
    }

    function generateRoundingExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxNum = Math.min(10000 * Math.pow(10, level), 99999999);
      const number = Math.floor(Math.random() * maxNum) + 10;
      const places = ['Z', 'H', 'T', 'ZT', 'HT', 'M'];
      const placeIndex = Math.min(level, places.length - 1);
      const place = places[placeIndex];
      
      const placeValues = { 'Z': 10, 'H': 100, 'T': 1000, 'ZT': 10000, 'HT': 100000, 'M': 1000000 };
      const roundTo = placeValues[place];
      const rounded = Math.round(number / roundTo) * roundTo;
      
      return {
        number: number,
        place: place,
        solution: rounded,
        tip: "Schaue auf die Ziffer rechts von der Rundungsstelle. Ist sie 5 oder gr√∂√üer, runde auf. Ist sie kleiner als 5, runde ab.",
        question: `Runde die Zahl auf die vorgegebene Stelle:`
      };
    }

    function generateDefinitionExercise(difficulty) {
      const questions = [
        { q: "Was ist der Unterschied zwischen Ziffer und Zahl?", a: "Eine Ziffer ist ein einzelnes Zeichen (0-9). Eine Zahl kann aus einer oder mehreren Ziffern bestehen und einen Wert darstellen (z.B. 123 besteht aus den Ziffern 1, 2 und 3)." },
        { q: "Wie viele Ziffern gibt es insgesamt?", a: "Es gibt 10 Ziffern: 0, 1, 2, 3, 4, 5, 6, 7, 8, 9" },
        { q: "Nenne ein Beispiel f√ºr eine Zahl mit 3 Ziffern.", a: "Beispiele: 123, 456, 789, 100, etc. (Jede Zahl zwischen 100 und 999)" },
        { q: "Was ist die kleinste einstellige nat√ºrliche Zahl?", a: "Die kleinste einstellige nat√ºrliche Zahl ist 1 (oder 0, wenn man die Null dazuz√§hlt)." },
        { q: "Wie nennt man Zahlen ohne Komma?", a: "Zahlen ohne Komma nennt man nat√ºrliche Zahlen oder ganze Zahlen." }
      ];
      
      const index = Math.floor(Math.random() * questions.length);
      return {
        question: questions[index].q,
        solution: questions[index].a,
        tip: "Denke daran: Ziffern sind die Bausteine (0-9), Zahlen sind das, was wir aus diesen Bausteinen bilden."
      };
    }

    function generateNumberlineExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      let step, range, min;
      
      const levels = [
        { step: 1, range: 10, min: 0 },
        { step: 2, range: 20, min: 0 },
        { step: 5, range: 50, min: 0 },
        { step: 10, range: 100, min: 0 },
        { step: 20, range: 200, min: 0 },
        { step: 50, range: 500, min: 0 },
        { step: 100, range: 1000, min: 0 },
        { step: 250, range: 2500, min: 0 },
        { step: 500, range: 5000, min: 0 },
        { step: 1000, range: 10000, min: 0 }
      ];
      
      const currentLevel = levels[Math.min(level, levels.length - 1)];
      step = currentLevel.step;
      range = currentLevel.range;
      min = currentLevel.min;
      
      const max = min + range;
      const possibleNumbers = [];
      for (let i = min; i <= max; i += step) {
        possibleNumbers.push(i);
      }
      
      const count = Math.min(2 + Math.floor(level / 2), 5);
      const numbers = [];
      const usedIndices = new Set();
      
      for (let i = 0; i < count && possibleNumbers.length > 0; i++) {
        let randomIndex;
        do {
          randomIndex = Math.floor(Math.random() * possibleNumbers.length);
        } while (usedIndices.has(randomIndex) && usedIndices.size < possibleNumbers.length);
        
        usedIndices.add(randomIndex);
        numbers.push(possibleNumbers[randomIndex]);
      }
      
      return {
        numbers: numbers,
        min: min,
        max: max,
        step: step,
        tip: `Der Zahlenstrahl ist in ${step}er-Schritte eingeteilt. Z√§hle die Schritte vom Anfang aus, um die richtige Position zu finden.`,
        question: `Klicke auf die richtigen Markierungen auf dem Zahlenstrahl:`
      };
    }

    // Decimal number exercise generators
    function generateDecimalStellenwertExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(1 + Math.floor(level / 2), 3);
      const maxWhole = Math.min(100 * Math.pow(10, Math.floor(level / 3)), 100000);
      
      let number = generateDecimal(maxWhole, decimalPlaces);
      
      return {
        number: number,
        tip: "Vor dem Komma: M, HT, ZT, T, H, Z, E. Nach dem Komma: z (Zehntel), h (Hundertstel), t (Tausendstel).",
        question: `Trage diese Dezimalzahl in die Stellenwerttabelle ein:`
      };
    }

    function generateDecimalOrderingExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const count = Math.min(4 + Math.floor(level / 2), 8);
      const decimalPlaces = Math.min(1 + Math.floor(level / 3), 3);
      const maxWhole = Math.min(10 * (level + 1), 100);
      const numbers = [];
      
      for (let i = 0; i < count; i++) {
        numbers.push(generateDecimal(maxWhole, decimalPlaces));
      }
      
      return {
        numbers: numbers,
        solution: [...numbers].sort((a, b) => a - b),
        tip: "Vergleiche zuerst die Zahlen vor dem Komma, dann die Nachkommastellen von links nach rechts.",
        question: `Ordne die Dezimalzahlen von der kleinsten bis zur gr√∂√üten:`
      };
    }

    function generateDecimalPlaceValueExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(2 + Math.floor(level / 3), 4);
      const maxWhole = Math.min(10 * (level + 1), 1000);
      
      const number = generateDecimal(maxWhole, decimalPlaces);
      const numStr = number.toString();
      const parts = numStr.split('.');
      
      // Pick a random digit from the number
      const allDigits = numStr.replace('.', '').split('');
      const digitIndex = Math.floor(Math.random() * allDigits.length);
      const digit = allDigits[digitIndex];
      
      // Determine the place value
      const wholePart = parts[0];
      const decimalPart = parts[1] || '';
      
      let placeValue;
      if (digitIndex < wholePart.length) {
        // Digit is in whole part
        const position = wholePart.length - digitIndex - 1;
        const places = ['E', 'Z', 'H', 'T', 'ZT', 'HT', 'M'];
        placeValue = places[position];
      } else {
        // Digit is in decimal part
        const decimalPosition = digitIndex - wholePart.length;
        const decimalPlaces = ['z', 'h', 't', 'zt'];
        placeValue = decimalPlaces[decimalPosition];
      }
      
      return {
        number: number,
        digit: digit,
        solution: placeValue,
        tip: "Z√§hle von rechts nach links vor dem Komma (E, Z, H, T...) und von links nach rechts nach dem Komma (z, h, t...).",
        question: `Welchen Stellenwert hat die Ziffer ${digit} in der Zahl ${number}?`
      };
    }

    function generateDecimalNumberlineMarkExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      let step, range, min;
      
      const levels = [
        { step: 0.1, range: 1, min: 0 },
        { step: 0.2, range: 2, min: 0 },
        { step: 0.5, range: 5, min: 0 },
        { step: 1, range: 10, min: 0 },
        { step: 2, range: 20, min: 0 },
        { step: 5, range: 50, min: 0 },
        { step: 10, range: 100, min: 0 },
        { step: 0.01, range: 0.1, min: 0 },
        { step: 0.05, range: 0.5, min: 0 },
        { step: 0.25, range: 2.5, min: 0 }
      ];
      
      const currentLevel = levels[Math.min(level, levels.length - 1)];
      step = currentLevel.step;
      range = currentLevel.range;
      min = currentLevel.min;
      
      const max = min + range;
      const possibleNumbers = [];
      let current = min;
      while (current <= max) {
        possibleNumbers.push(parseFloat(current.toFixed(2)));
        current += step;
      }
      
      const count = Math.min(2 + Math.floor(level / 3), 4);
      const numbers = [];
      const usedIndices = new Set();
      
      for (let i = 0; i < count && possibleNumbers.length > 0; i++) {
        let randomIndex;
        do {
          randomIndex = Math.floor(Math.random() * possibleNumbers.length);
        } while (usedIndices.has(randomIndex) && usedIndices.size < possibleNumbers.length);
        
        usedIndices.add(randomIndex);
        numbers.push(possibleNumbers[randomIndex]);
      }
      
      return {
        numbers: numbers,
        min: min,
        max: max,
        step: step,
        tip: `Der Zahlenstrahl ist in ${step}er-Schritte eingeteilt. Z√§hle genau die Dezimalschritte.`,
        question: `Klicke auf die richtigen Dezimalzahlen auf dem Zahlenstrahl:`
      };
    }

    function generateDecimalNumberlineReadExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      let step, range, min;
      
      const levels = [
        { step: 0.1, range: 1, min: 0 },
        { step: 0.2, range: 2, min: 0 },
        { step: 0.5, range: 5, min: 0 },
        { step: 1, range: 10, min: 0 },
        { step: 2, range: 20, min: 0 },
        { step: 0.01, range: 0.1, min: 0 },
        { step: 0.05, range: 0.5, min: 0 },
        { step: 0.25, range: 2.5, min: 0 },
        { step: 5, range: 50, min: 0 },
        { step: 10, range: 100, min: 0 }
      ];
      
      const currentLevel = levels[Math.min(level, levels.length - 1)];
      step = currentLevel.step;
      range = currentLevel.range;
      min = currentLevel.min;
      
      const max = min + range;
      const possibleNumbers = [];
      let current = min;
      while (current <= max) {
        possibleNumbers.push(parseFloat(current.toFixed(2)));
        current += step;
      }
      
      const count = Math.min(2 + Math.floor(level / 3), 4);
      const markedNumbers = [];
      const usedIndices = new Set();
      
      for (let i = 0; i < count && possibleNumbers.length > 0; i++) {
        let randomIndex;
        do {
          randomIndex = Math.floor(Math.random() * possibleNumbers.length);
        } while (usedIndices.has(randomIndex) && usedIndices.size < possibleNumbers.length);
        
        usedIndices.add(randomIndex);
        markedNumbers.push(possibleNumbers[randomIndex]);
      }
      
      return {
        markedNumbers: markedNumbers,
        min: min,
        max: max,
        step: step,
        tip: `Z√§hle die Schritte vom Anfang aus. Jeder Schritt ist ${step}.`,
        question: `Lies die markierten Dezimalzahlen vom Zahlenstrahl ab:`
      };
    }

    function generateDecimalRoundingExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(2 + Math.floor(level / 3), 4);
      const maxWhole = Math.min(10 * (level + 1), 1000);
      
      const number = generateDecimal(maxWhole, decimalPlaces);
      const roundingOptions = ['Zehntel', 'Hundertstel'];
      const roundTo = roundingOptions[Math.min(Math.floor(level / 5), 1)];
      
      let rounded;
      if (roundTo === 'Zehntel') {
        rounded = Math.round(number * 10) / 10;
      } else {
        rounded = Math.round(number * 100) / 100;
      }
      
      return {
        number: number,
        roundTo: roundTo,
        solution: rounded,
        tip: "Schaue auf die Ziffer rechts von der Rundungsstelle. Bei 5 oder gr√∂√üer aufrunden, sonst abrunden.",
        question: `Runde die Dezimalzahl:`
      };
    }

    function generateMoneyConversionExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const euros = Math.floor(Math.random() * (10 * (level + 1)));
      const cents = Math.floor(Math.random() * 100);
      
      const toDecimal = Math.random() > 0.5;
      
      if (toDecimal) {
        return {
          euros: euros,
          cents: cents,
          toDecimal: true,
          solution: parseFloat(euros + (cents / 100).toFixed(2)),
          tip: "1 Euro = 100 Cent. Teile die Cent durch 100, um sie in Euro umzuwandeln.",
          question: `Wandle in Dezimalschreibweise um:`
        };
      } else {
        const decimal = parseFloat(euros + (cents / 100).toFixed(2));
        return {
          decimal: decimal,
          toDecimal: false,
          solution: { euros: Math.floor(decimal), cents: Math.round((decimal % 1) * 100) },
          tip: "Die Zahl vor dem Komma sind die Euro, die zwei Stellen nach dem Komma sind die Cent.",
          question: `Wandle in gemischte Schreibweise (‚Ç¨ und c) um:`
        };
      }
    }

    function generateDecimalAlignmentExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces1 = Math.min(1 + Math.floor(level / 3), 3);
      const decimalPlaces2 = Math.min(1 + Math.floor(level / 3), 3);
      const maxWhole = Math.min(100 * (level + 1), 10000);
      
      const num1 = generateDecimal(maxWhole, decimalPlaces1);
      const num2 = generateDecimal(maxWhole / 2, decimalPlaces2);
      const operation = Math.random() > 0.5 ? '+' : '-';
      
      return {
        num1: num1,
        num2: num2,
        operation: operation,
        tip: "Schreibe die Zahlen so untereinander, dass die Kommas genau untereinander stehen.",
        question: `Schreibe stellenwertrichtig untereinander:`
      };
    }

    function generateDecimalAdditionExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(1 + Math.floor(level / 3), 2);
      const maxWhole = Math.min(10 * (level + 1), 1000);
      
      const num1 = generateDecimal(maxWhole, decimalPlaces);
      const num2 = generateDecimal(maxWhole / 2, decimalPlaces);
      const solution = parseFloat((num1 + num2).toFixed(1));
      
      return {
        num1: num1,
        num2: num2,
        solution: solution,
        tip: "Addiere stellenwertrichtig. Komma unter Komma!",
        question: `Addiere:`
      };
    }

    function generateDecimalSubtractionExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(1 + Math.floor(level / 3), 2);
      const maxWhole = Math.min(10 * (level + 1), 1000);
      
      const num1 = generateDecimal(maxWhole, decimalPlaces);
      const num2 = generateDecimal(Math.min(num1, maxWhole / 2), decimalPlaces);
      const solution = parseFloat((num1 - num2).toFixed(1));
      
      return {
        num1: num1,
        num2: num2,
        solution: solution,
        tip: "Subtrahiere stellenwertrichtig. Komma unter Komma!",
        question: `Subtrahiere:`
      };
    }

    function generateDecimalMultiplyNaturalExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(1 + Math.floor(level / 4), 2);
      const maxDecimal = Math.min(10 * (level + 1), 100);
      const maxNatural = Math.min(2 + level, 20);
      
      const decimal = generateDecimal(maxDecimal, decimalPlaces);
      const natural = Math.floor(Math.random() * maxNatural) + 1;
      const solution = parseFloat((decimal * natural).toFixed(1));
      
      return {
        num1: decimal,
        num2: natural,
        solution: solution,
        tip: "Multipliziere wie gewohnt und setze das Komma richtig. Z√§hle die Nachkommastellen.",
        question: `Multipliziere:`
      };
    }

    function generateDecimalMultiplyDecimalExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces1 = Math.min(1 + Math.floor(level / 4), 2);
      const decimalPlaces2 = Math.min(1 + Math.floor(level / 4), 2);
      const maxDecimal = Math.min(5 * (level + 1), 50);
      
      const num1 = generateDecimal(maxDecimal, decimalPlaces1);
      const num2 = generateDecimal(maxDecimal / 2, decimalPlaces2);
      const solution = parseFloat((num1 * num2).toFixed(1));
      
      return {
        num1: num1,
        num2: num2,
        solution: solution,
        tip: "Multipliziere ohne Komma, dann z√§hle alle Nachkommastellen zusammen und setze das Komma.",
        question: `Multipliziere:`
      };
    }

    function generateDecimalMultiplyPowersExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(1 + Math.floor(level / 3), 3);
      const maxWhole = Math.min(10 * (level + 1), 1000);
      
      const number = generateDecimal(maxWhole, decimalPlaces);
      const powers = [10, 100, 1000];
      const power = powers[Math.min(Math.floor(level / 3), 2)];
      const solution = parseFloat((number * power).toFixed(1));
      
      return {
        number: number,
        power: power,
        solution: solution,
        tip: `Bei Multiplikation mit ${power} verschiebe das Komma um ${Math.log10(power)} Stellen nach rechts.`,
        question: `Berechne durch Kommaverschieben:`
      };
    }

    function generateDecimalDividePowersExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(1 + Math.floor(level / 3), 2);
      const maxWhole = Math.min(100 * (level + 1), 10000);
      
      const number = generateDecimal(maxWhole, decimalPlaces);
      const powers = [10, 100, 1000];
      const power = powers[Math.min(Math.floor(level / 3), 2)];
      const solution = parseFloat((number / power).toFixed(1));
      
      return {
        number: number,
        power: power,
        solution: solution,
        tip: `Bei Division durch ${power} verschiebe das Komma um ${Math.log10(power)} Stellen nach links.`,
        question: `Berechne durch Kommaverschieben:`
      };
    }

    function generateNaturalDivideDecimalExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const maxDividend = Math.min(20 * (level + 1), 200);
      const maxDivisor = Math.min(2 + level, 20);
      
      const dividend = Math.floor(Math.random() * maxDividend) + 1;
      const divisor = Math.floor(Math.random() * maxDivisor) + 2;
      const solution = parseFloat((dividend / divisor).toFixed(1));
      
      return {
        dividend: dividend,
        divisor: divisor,
        solution: solution,
        tip: "Dividiere wie gewohnt. Wenn n√∂tig, fÔøΩÔøΩÔøΩÔøΩge Nullen hinzu und setze ein Komma.",
        question: `Dividiere (Ergebnis ist eine Dezimalzahl):`
      };
    }

    function generateDecimalDivideNaturalExercise(difficulty) {
      const level = Math.floor(difficulty / EXERCISES_PER_LEVEL);
      const decimalPlaces = Math.min(1 + Math.floor(level / 4), 2);
      const maxDecimal = Math.min(50 * (level + 1), 500);
      const maxDivisor = Math.min(2 + level, 20);
      
      const decimal = generateDecimal(maxDecimal, decimalPlaces);
      const divisor = Math.floor(Math.random() * maxDivisor) + 2;
      const solution = parseFloat((decimal / divisor).toFixed(1));
      
      return {
        decimal: decimal,
        divisor: divisor,
        solution: solution,
        tip: "Dividiere wie bei nat√ºrlichen Zahlen, aber behalte das Komma an der richtigen Stelle.",
        question: `Dividiere:`
      };
    }

    function generateExercises(type, count) {
      const exercises = [];
      for (let i = 0; i < count; i++) {
        const difficulty = i;
        let exercise;
        
        switch(type) {
          // Br√ºche exercises
          case 'fraction_parts':
            exercise = generateFractionPartsExercise(difficulty);
            break;
          case 'fraction_visual':
            exercise = generateFractionVisualExercise(difficulty);
            break;
          case 'fraction_types':
            exercise = generateFractionTypesExercise(difficulty);
            break;
          case 'fraction_expand':
            exercise = generateFractionExpandExercise(difficulty);
            break;
          case 'fraction_reduce':
            exercise = generateFractionReduceExercise(difficulty);
            break;
          case 'fraction_add_same':
            exercise = generateFractionAddSameExercise(difficulty);
            break;
          case 'fraction_subtract_same':
            exercise = generateFractionSubtractSameExercise(difficulty);
            break;
          case 'fraction_add_different':
            exercise = generateFractionAddDifferentExercise(difficulty);
            break;
          case 'fraction_subtract_different':
            exercise = generateFractionSubtractDifferentExercise(difficulty);
            break;
          case 'fraction_three_operations':
            exercise = generateFractionThreeOperationsExercise(difficulty);
            break;
          case 'fraction_to_decimal':
            exercise = generateFractionToDecimalExercise(difficulty);
            break;
          case 'decimal_to_fraction':
            exercise = generateDecimalToFractionExercise(difficulty);
            break;
          case 'mixed_to_improper':
            exercise = generateMixedToImproperExercise(difficulty);
            break;
          case 'mixed_addition':
            exercise = generateMixedAdditionExercise(difficulty);
            break;
          case 'mixed_subtraction':
            exercise = generateMixedSubtractionExercise(difficulty);
            break;
          case 'fraction_multiply':
            exercise = generateFractionMultiplyExercise(difficulty);
            break;
          case 'fraction_multiply_natural':
            exercise = generateFractionMultiplyNaturalExercise(difficulty);
            break;
          case 'mixed_multiply':
            exercise = generateMixedMultiplyExercise(difficulty);
            break;
          case 'fraction_reciprocal':
            exercise = generateFractionReciprocalExercise(difficulty);
            break;
          case 'fraction_divide':
            exercise = generateFractionDivideExercise(difficulty);
            break;
          case 'fraction_divide_natural':
            exercise = generateFractionDivideNaturalExercise(difficulty);
            break;
          case 'mixed_divide':
            exercise = generateMixedDivideExercise(difficulty);
            break;
          case 'fraction_order':
            exercise = generateFractionOrderExercise(difficulty);
            break;
          case 'fraction_word_problems':
            exercise = generateFractionWordProblemExercise(difficulty);
            break;
            
          // Gleichungen 4. Klasse exercises
          case 'one_step_equations':
            exercise = generateOneStepEquationExercise(difficulty);
            break;
          case 'simple_multi_step_equations':
            exercise = generateSimpleMultiStepEquationExercise(difficulty);
            break;
          case 'complex_multi_step_equations':
            exercise = generateComplexMultiStepEquationExercise(difficulty);
            break;
          case 'equation_proof':
            exercise = generateEquationProofExercise(difficulty);
            break;
          case 'quadratic_equations':
            exercise = generateQuadraticEquationExercise(difficulty);
            break;
          case 'text_equations':
            exercise = generateTextEquationExercise(difficulty);
            break;
          case 'final_game':
            exercise = {
              question: "üéÆ Abschlussspiel",
              tip: "Viel Erfolg!",
              solution: 0
            };
            break;
            
          // Gleichungen exercises (alt - kann gel√∂scht werden)
          case 'simple_equations':
            exercise = generateSimpleEquationExercise(difficulty);
            break;
          case 'bracket_equations':
            exercise = generateBracketEquationExercise(difficulty);
            break;
          case 'fraction_equations':
            exercise = generateFractionEquationExercise(difficulty);
            break;
          case 'word_equations':
            exercise = generateWordEquationExercise(difficulty);
            break;
            
          // Natural number exercises
          case 'ordering':
            exercise = generateOrderingExercise(difficulty);
            break;
          case 'predecessor':
            exercise = generatePredecessorExercise(difficulty);
            break;
          case 'stellenwert':
            exercise = generateStellenwertExercise(difficulty);
            break;
          case 'rounding':
            exercise = generateRoundingExercise(difficulty);
            break;
          case 'definition':
            exercise = generateDefinitionExercise(difficulty);
            break;
          case 'numberline':
            exercise = generateNumberlineExercise(difficulty);
            break;
            
          // Decimal number exercises
          case 'decimal_stellenwert':
            exercise = generateDecimalStellenwertExercise(difficulty);
            break;
          case 'decimal_ordering':
            exercise = generateDecimalOrderingExercise(difficulty);
            break;
          case 'decimal_place_value':
            exercise = generateDecimalPlaceValueExercise(difficulty);
            break;
          case 'decimal_numberline_mark':
            exercise = generateDecimalNumberlineMarkExercise(difficulty);
            break;
          case 'decimal_numberline_read':
            exercise = generateDecimalNumberlineReadExercise(difficulty);
            break;
          case 'decimal_rounding':
            exercise = generateDecimalRoundingExercise(difficulty);
            break;
          case 'money_conversion':
            exercise = generateMoneyConversionExercise(difficulty);
            break;
          case 'decimal_alignment':
            exercise = generateDecimalAlignmentExercise(difficulty);
            break;
          case 'decimal_addition':
            exercise = generateDecimalAdditionExercise(difficulty);
            break;
          case 'decimal_subtraction':
            exercise = generateDecimalSubtractionExercise(difficulty);
            break;
          case 'decimal_multiply_natural':
            exercise = generateDecimalMultiplyNaturalExercise(difficulty);
            break;
          case 'decimal_multiply_decimal':
            exercise = generateDecimalMultiplyDecimalExercise(difficulty);
            break;
          case 'decimal_multiply_powers':
            exercise = generateDecimalMultiplyPowersExercise(difficulty);
            break;
          case 'decimal_divide_powers':
            exercise = generateDecimalDividePowersExercise(difficulty);
            break;
          case 'natural_divide_decimal':
            exercise = generateNaturalDivideDecimalExercise(difficulty);
            break;
          case 'decimal_divide_natural':
            exercise = generateDecimalDivideNaturalExercise(difficulty);
            break;
        }
        
        exercises.push(exercise);
      }
      
      return exercises;
    }

    function showTopics(classId) {
      currentClass = classId;
      currentView = 'topics';
      document.getElementById('mainView').classList.add('hidden');
      document.getElementById('topicsView').classList.remove('hidden');
      document.getElementById('exerciseView').classList.add('hidden');
      
      const classLabels = {
        'class1': window.elementSdk?.config?.class_1_label || defaultConfig.class_1_label,
        'class2': window.elementSdk?.config?.class_2_label || defaultConfig.class_2_label,
        'class3': window.elementSdk?.config?.class_3_label || defaultConfig.class_3_label,
        'class4': window.elementSdk?.config?.class_4_label || defaultConfig.class_4_label,
        'dfk': window.elementSdk?.config?.dfk_label || defaultConfig.dfk_label
      };
      
      document.getElementById('topicsTitle').textContent = classLabels[classId];
      
      const topicsContent = document.getElementById('topicsContent');
      const topics = classTopics[classId];
      
      if (topics && topics.length > 0) {
        let html = '<div class="topics-grid">';
        topics.forEach((topic, index) => {
          html += `<button class="topic-button" onclick="showLearningGoals('${classId}', ${index})">${topic}</button>`;
        });
        html += '</div>';
        topicsContent.innerHTML = html;
      } else {
        topicsContent.innerHTML = `
          <div class="empty-topics">
            <div class="empty-icon">üìö</div>
            <p>Hier werden die Themen angezeigt, sobald sie hinzugef√ºgt werden.</p>
          </div>
        `;
      }
    }

    function showLearningGoals(classId, topicIndex) {
      currentTopic = classTopics[classId][topicIndex];
      
      if (!learningGoals[currentTopic]) {
        showCustomMessage("Dieses Thema wird noch erstellt.", "topicsView");
        return;
      }
      
      currentView = 'learning-goals';
      document.getElementById('topicsView').classList.add('hidden');
      
      const topicsContent = document.getElementById('topicsContent');
      document.getElementById('topicsTitle').textContent = currentTopic;
      
      let html = '<div class="topics-grid">';
      learningGoals[currentTopic].forEach((goal, index) => {
        html += `<button class="topic-button" onclick="startExercises(${index})">${goal.title}</button>`;
      });
      html += '</div>';
      topicsContent.innerHTML = html;
      
      document.getElementById('topicsView').classList.remove('hidden');
    }

    function startExercises(goalIndex) {
      currentGoalIndex = goalIndex;
      const goal = learningGoals[currentTopic][goalIndex];
      
      currentExercises = generateExercises(goal.type, goal.exercises);
      currentExerciseIndex = 0;
      
      document.getElementById('topicsView').classList.add('hidden');
      document.getElementById('exerciseView').classList.remove('hidden');
      document.getElementById('exerciseTitle').textContent = goal.title;
      
      displayExercise();
    }

    function displayExercise() {
      const goal = learningGoals[currentTopic][currentGoalIndex];
      const exercise = currentExercises[currentExerciseIndex];
      
      attemptCount = 0;
      
      document.getElementById('exerciseProgress').textContent = 
        `Aufgabe ${currentExerciseIndex + 1} von ${currentExercises.length}`;
      
      document.getElementById('tipBox').classList.remove('show');
      document.getElementById('feedbackBox').classList.remove('show');
      document.getElementById('feedbackBox').classList.remove('correct');
      document.getElementById('feedbackBox').classList.remove('incorrect');
      document.getElementById('tipContent').textContent = exercise.tip;
      
      // For explanation page (first exercise of fraction_parts), always show next button
      if (goal.type === 'fraction_parts' && exercise.isExplanation) {
        const controls = document.querySelector('.exercise-controls');
        if (!document.getElementById('nextBtn')) {
          const nextBtn = document.createElement('button');
          nextBtn.id = 'nextBtn';
          nextBtn.className = 'next-button';
          nextBtn.textContent = 'Weiter ‚Üí';
          nextBtn.onclick = nextExercise;
          controls.appendChild(nextBtn);
        }
      } else {
        // Remove next button for other exercises
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
          nextBtn.remove();
        }
      }
      
      let questionHTML = '';
      let answerHTML = '';
      
      // Br√ºche display logic
      if (goal.type === 'fraction_parts') {
        if (exercise.isExplanation) {
          // Explanation page
          questionHTML = exercise.question;
          answerHTML = `
            <div style="margin: 30px 0; padding: 30px; background: #f8f9fa; border-radius: 15px; border-left: 5px solid #2c5f8d;">
              <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 48px; font-weight: 700; color: #2c5f8d; margin-bottom: 10px;">
                  <div>3</div>
                  <div style="border-top: 3px solid #2c5f8d; width: 60px; margin: 5px auto;"></div>
                  <div>4</div>
                </div>
              </div>
              
              <div style="font-size: 20px; line-height: 1.8; color: #333;">
                <p style="margin-bottom: 20px;"><strong style="color: #2c5f8d; font-size: 24px;">Ein Bruch besteht aus drei Teilen:</strong></p>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                  <p style="margin: 10px 0;"><strong style="color: #4a8fc7;">1. Der Z√§hler</strong> (steht <strong>oben</strong>)</p>
                  <p style="margin-left: 20px; color: #666;">‚Üí zeigt, wie viele Teile genommen werden</p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                  <p style="margin: 10px 0;"><strong style="color: #4a8fc7;">2. Der Bruchstrich</strong> (steht in der <strong>Mitte</strong>)</p>
                  <p style="margin-left: 20px; color: #666;">‚Üí bedeutet "geteilt durch"</p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                  <p style="margin: 10px 0;"><strong style="color: #4a8fc7;">3. Der Nenner</strong> (steht <strong>unten</strong>)</p>
                  <p style="margin-left: 20px; color: #666;">‚Üí zeigt, in wie viele Teile das Ganze geteilt ist</p>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px;">
                  <p style="margin: 0;"><strong>Beispiel:</strong> Bei <strong style="color: #2c5f8d;">3/4</strong> (drei Viertel) ist das Ganze in <strong>4 Teile</strong> geteilt und wir nehmen <strong>3 davon</strong>.</p>
                </div>
              </div>
            </div>
          `;
        } else {
          // Matching task page
          questionHTML = exercise.question;
          answerHTML = `
            <div style="margin: 30px 0;">
              <div style="text-align: center; margin-bottom: 40px;">
                <div style="display: inline-block; position: relative;">
                  <div style="font-size: 64px; font-weight: 700; color: #2c5f8d;">
                    <div style="padding: 20px; border: 3px solid #2c5f8d; border-radius: 10px; margin-bottom: 5px; background: white;">
                      ${exercise.num}
                    </div>
                    <div style="border-top: 4px solid #2c5f8d; margin: 10px 0;"></div>
                    <div style="padding: 20px; border: 3px solid #2c5f8d; border-radius: 10px; margin-top: 5px; background: white;">
                      ${exercise.den}
                    </div>
                  </div>
                </div>
              </div>
              
              <div style="display: flex; flex-direction: column; gap: 20px; max-width: 400px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 15px;">
                  <label style="font-size: 20px; font-weight: 600; width: 200px;">Oben steht der:</label>
                  <select id="topSelect" class="answer-input" style="width: 180px; font-size: 18px; padding: 10px;">
                    <option value="">W√§hle...</option>
                    <option value="Z√§hler">Z√§hler</option>
                    <option value="Bruchstrich">Bruchstrich</option>
                    <option value="Nenner">Nenner</option>
                  </select>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                  <label style="font-size: 20px; font-weight: 600; width: 200px;">In der Mitte ist der:</label>
                  <select id="middleSelect" class="answer-input" style="width: 180px; font-size: 18px; padding: 10px;">
                    <option value="">W√§hle...</option>
                    <option value="Z√§hler">Z√§hler</option>
                    <option value="Bruchstrich">Bruchstrich</option>
                    <option value="Nenner">Nenner</option>
                  </select>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                  <label style="font-size: 20px; font-weight: 600; width: 200px;">Unten steht der:</label>
                  <select id="bottomSelect" class="answer-input" style="width: 180px; font-size: 18px; padding: 10px;">
                    <option value="">W√§hle...</option>
                    <option value="Z√§hler">Z√§hler</option>
                    <option value="Bruchstrich">Bruchstrich</option>
                    <option value="Nenner">Nenner</option>
                  </select>
                </div>
              </div>
            </div>
          `;
        }
      } else if (goal.type === 'fraction_visual') {
        questionHTML = exercise.question;
        // Draw circle divided into parts
        const angle = 360 / exercise.den;
        let svgPaths = '';
        for (let i = 0; i < exercise.den; i++) {
          const startAngle = i * angle - 90;
          const endAngle = (i + 1) * angle - 90;
          const x1 = 100 + 80 * Math.cos(startAngle * Math.PI / 180);
          const y1 = 100 + 80 * Math.sin(startAngle * Math.PI / 180);
          const x2 = 100 + 80 * Math.cos(endAngle * Math.PI / 180);
          const y2 = 100 + 80 * Math.sin(endAngle * Math.PI / 180);
          
          const largeArc = angle > 180 ? 1 : 0;
          const fill = i < exercise.num ? '#4a8fc7' : '#f0f0f0';
          
          svgPaths += `<path d="M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${fill}" stroke="#2c5f8d" stroke-width="2"/>`;
        }
        
        answerHTML = `
          <div style="text-align: center; margin: 30px 0;">
            <svg width="220" height="220" style="margin: 20px auto; display: block;">
              ${svgPaths}
            </svg>
            <div style="margin-top: 30px; display: flex; align-items: center; justify-content: center; gap: 10px;">
              <input type="number" id="numerator" class="answer-input" placeholder="Z√§hler" style="width: 100px;">
              <div style="font-size: 32px; font-weight: bold;">/</div>
              <input type="number" id="denominator" class="answer-input" placeholder="Nenner" style="width: 100px;">
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_types') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;" id="fractionCards">
              ${exercise.fractions.map((frac, idx) => {
                const display = frac.whole !== undefined 
                  ? formatMixedNumber(frac.whole, frac.num, frac.den)
                  : formatFraction(frac.num, frac.den);
                return `<div class="fraction-card" draggable="true" data-index="${idx}" data-type="${frac.type}" style="background: white; border: 2px solid #2c5f8d; padding: 20px; text-align: center; font-size: 24px; cursor: move; border-radius: 10px; font-weight: 600;">${display}</div>`;
              }).join('')}
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px;">
              <div class="drop-zone" data-category="proper" style="border: 3px dashed #2c5f8d; padding: 30px; min-height: 200px; border-radius: 10px; background: #f8f9fa;">
                <h3 style="text-align: center; color: #2c5f8d; margin-bottom: 20px;">Echter Bruch</h3>
                <div class="drop-content"></div>
              </div>
              <div class="drop-zone" data-category="improper" style="border: 3px dashed #2c5f8d; padding: 30px; min-height: 200px; border-radius: 10px; background: #f8f9fa;">
                <h3 style="text-align: center; color: #2c5f8d; margin-bottom: 20px;">Unechter Bruch</h3>
                <div class="drop-content"></div>
              </div>
              <div class="drop-zone" data-category="mixed" style="border: 3px dashed #2c5f8d; padding: 30px; min-height: 200px; border-radius: 10px; background: #f8f9fa;">
                <h3 style="text-align: center; color: #2c5f8d; margin-bottom: 20px;">Gemischte Zahl</h3>
                <div class="drop-content"></div>
              </div>
            </div>
          </div>
        `;
        
        setTimeout(() => {
          const cards = document.querySelectorAll('.fraction-card');
          const dropZones = document.querySelectorAll('.drop-zone');
          
          cards.forEach(card => {
            card.addEventListener('dragstart', (e) => {
              e.dataTransfer.setData('text/plain', e.target.dataset.index);
              e.target.style.opacity = '0.5';
            });
            
            card.addEventListener('dragend', (e) => {
              e.target.style.opacity = '1';
            });
          });
          
          dropZones.forEach(zone => {
            zone.addEventListener('dragover', (e) => {
              e.preventDefault();
              zone.style.background = '#e3f2fd';
            });
            
            zone.addEventListener('dragleave', () => {
              zone.style.background = '#f8f9fa';
            });
            
            zone.addEventListener('drop', (e) => {
              e.preventDefault();
              zone.style.background = '#f8f9fa';
              
              const cardIndex = e.dataTransfer.getData('text/plain');
              const card = document.querySelector(`.fraction-card[data-index="${cardIndex}"]`);
              
              if (card) {
                const dropContent = zone.querySelector('.drop-content');
                dropContent.appendChild(card);
              }
            });
          });
        }, 100);
      } else if (goal.type === 'fraction_expand') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num}/${exercise.den}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="newNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="newDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
            <p style="text-align: center; margin-top: 20px; font-size: 20px;">Erweitere mit <strong>${exercise.factor}</strong></p>
          </div>
        `;
      } else if (goal.type === 'fraction_reduce') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num}/${exercise.den}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="reducedNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="reducedDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_add_same' || goal.type === 'fraction_subtract_same') {
        const operator = goal.type === 'fraction_add_same' ? '+' : '-';
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num1}/${exercise.den}</span>
              <span>${operator}</span>
              <span style="font-weight: 600;">${exercise.num2}/${exercise.den}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="resultNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="resultDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_add_different' || goal.type === 'fraction_subtract_different') {
        const operator = goal.type === 'fraction_add_different' ? '+' : '-';
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num1}/${exercise.den1}</span>
              <span>${operator}</span>
              <span style="font-weight: 600;">${exercise.num2}/${exercise.den2}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="resultNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">ÔøΩÔøΩ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="resultDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_three_operations') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; font-size: 24px; margin-bottom: 30px;">
              <span style="font-weight: 600;">${exercise.num1}/${exercise.den1}</span>
              <span>${exercise.operation1}</span>
              <span style="font-weight: 600;">${exercise.num2}/${exercise.den2}</span>
              <span>${exercise.operation2}</span>
              <span style="font-weight: 600;">${exercise.num3}/${exercise.den3}</span>
            </div>
            
            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
              <p style="font-size: 20px; font-weight: 600; color: #2c5f8d; margin-bottom: 15px;">Schritt 1: Auf gemeinsamen Nenner bringen</p>
              <div style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; gap: 10px; align-items: center; justify-content: center; font-size: 22px;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 5px; justify-self: end;">
                  <input type="number" id="step1_num1" class="answer-input" placeholder="?" style="width: 80px;">
                  <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                  <input type="number" id="step1_den1" class="answer-input" placeholder="?" style="width: 80px;">
                </div>
                <span style="justify-self: center;">${exercise.operation1}</span>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 5px; justify-self: center;">
                  <input type="number" id="step1_num2" class="answer-input" placeholder="?" style="width: 80px;">
                  <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                  <input type="number" id="step1_den2" class="answer-input" placeholder="?" style="width: 80px;">
                </div>
                <span style="justify-self: center;">${exercise.operation2}</span>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 5px; justify-self: start;">
                  <input type="number" id="step1_num3" class="answer-input" placeholder="?" style="width: 80px;">
                  <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                  <input type="number" id="step1_den3" class="answer-input" placeholder="?" style="width: 80px;">
                </div>
              </div>
            </div>
            
            <div style="background: #e3f2fd; padding: 25px; border-radius: 12px;">
              <p style="font-size: 20px; font-weight: 600; color: #2c5f8d; margin-bottom: 15px;">Schritt 2: Ergebnis berechnen und k√ºrzen</p>
              <div style="display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 22px;">
                <span>=</span>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                  <input type="number" id="resultNum" class="answer-input" placeholder="?" style="width: 100px;">
                  <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                  <input type="number" id="resultDen" class="answer-input" placeholder="?" style="width: 100px;">
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_to_decimal') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num}/${exercise.den}</span>
              <span>=</span>
              <input type="text" class="answer-input" placeholder="0,..." style="width: 150px;">
            </div>
          </div>
        `;
      } else if (goal.type === 'decimal_to_fraction') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; font-size: 28px;">
              <span style="font-weight: 600;">${formatDecimal(exercise.decimal)}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="fracNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="fracDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'mixed_to_improper') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; font-size: 28px;">
              <span style="font-weight: 600;">${formatMixedNumber(exercise.whole, exercise.num, exercise.den)}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="impNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="impDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'mixed_addition' || goal.type === 'mixed_subtraction') {
        const operator = goal.type === 'mixed_addition' ? '+' : '-';
        questionHTML = exercise.question;
        const mixed1 = formatMixedNumber(exercise.whole1, exercise.num1, exercise.den1);
        const mixed2 = formatMixedNumber(exercise.whole2, exercise.num2, exercise.den2);
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${mixed1}</span>
              <span>${operator}</span>
              <span style="font-weight: 600;">${mixed2}</span>
              <span>=</span>
              <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" id="wholeResult" class="answer-input" placeholder="Ganze" style="width: 90px;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                  <input type="number" id="numResult" class="answer-input" placeholder="?" style="width: 80px;">
                  <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ</div>
                  <input type="number" id="denResult" class="answer-input" placeholder="?" style="width: 80px;">
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_multiply') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num1}/${exercise.den1}</span>
              <span>¬∑</span>
              <span style="font-weight: 600;">${exercise.num2}/${exercise.den2}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="resultNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="resultDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_multiply_natural') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num}/${exercise.den}</span>
              <span>¬∑</span>
              <span style="font-weight: 600;">${exercise.natural}</span>
              <span>=</span>
              <input type="text" class="answer-input" id="mixedResult" placeholder="z.B. 2 3/4" style="width: 150px;">
            </div>
            <p style="text-align: center; margin-top: 15px; color: #666; font-size: 16px;">Gib als gemischte Zahl oder Bruch an</p>
          </div>
        `;
      } else if (goal.type === 'mixed_multiply') {
        questionHTML = exercise.question;
        const mixed1 = formatMixedNumber(exercise.whole1, exercise.num1, exercise.den1);
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${mixed1}</span>
              <span>¬∑</span>
              <span style="font-weight: 600;">${exercise.num2}/${exercise.den2}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="resultNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="resultDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_reciprocal') {
        questionHTML = exercise.question;
        const display = exercise.den === 1 ? exercise.num.toString() : `${exercise.num}/${exercise.den}`;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; font-size: 32px;">
              <span style="font-weight: 600;">${display}</span>
              <span>‚Üí</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="recipNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="recipDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_divide') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num1}/${exercise.den1}</span>
              <span>:</span>
              <span style="font-weight: 600;">${exercise.num2}/${exercise.den2}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="resultNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="resultDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_divide_natural') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${exercise.num}/${exercise.den}</span>
              <span>:</span>
              <span style="font-weight: 600;">${exercise.natural}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="resultNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="resultDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'mixed_divide') {
        questionHTML = exercise.question;
        const mixed1 = formatMixedNumber(exercise.whole1, exercise.num1, exercise.den1);
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 28px;">
              <span style="font-weight: 600;">${mixed1}</span>
              <span>:</span>
              <span style="font-weight: 600;">${exercise.num2}/${exercise.den2}</span>
              <span>=</span>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="number" id="resultNum" class="answer-input" placeholder="?" style="width: 100px;">
                <div style="font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <input type="number" id="resultDen" class="answer-input" placeholder="?" style="width: 100px;">
              </div>
            </div>
          </div>
        `;
      } else if (goal.type === 'fraction_order') {
        questionHTML = exercise.question;
        const mixed = formatMixedNumber(exercise.whole, exercise.num1, exercise.den1);
        answerHTML = `
          <div style="margin: 30px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; font-size: 24px;">
              <span style="font-weight: 600;">${mixed}</span>
              <span>+</span>
              <span style="font-weight: 600;">${exercise.num2}/${exercise.den2}</span>
              <span>¬∑</span>
              <span style="font-weight: 600;">${exercise.num3}/${exercise.den3}</span>
              <span>=</span>
              <input type="text" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
            </div>
            <p style="text-align: center; margin-top: 15px; color: #dc3545; font-weight: 600;">Achtung: Punkt vor Strich!</p>
          </div>
        `;
      } else if (goal.type === 'fraction_word_problems') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="margin: 20px 0; padding: 25px; background: #f8f9fa; border-left: 5px solid #2c5f8d; border-radius: 8px; line-height: 1.8;">
            <p style="font-size: 20px;">${exercise.problem}</p>
          </div>
          <div style="margin-top: 25px;">
            <p style="font-size: 18px; margin-bottom: 10px;">Deine Antwort:</p>
            <textarea class="answer-textarea" id="wordAnswer" placeholder="Schreibe deine vollst√§ndige L√∂sung mit Rechenweg..." style="min-height: 120px;"></textarea>
          </div>
        `;
      } else if (goal.type === 'one_step_equations' || goal.type === 'simple_multi_step_equations' || 
          goal.type === 'complex_multi_step_equations' || goal.type === 'quadratic_equations') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 28px; margin: 30px 0; padding: 25px; background: white; border: 3px solid #2c5f8d; border-radius: 12px; font-weight: 600;">
            ${exercise.equation}
          </div>
          <div style="margin-top: 20px;">
            <p style="font-size: 20px; margin-bottom: 10px;">Deine L√∂sung f√ºr x:</p>
            <input type="number" step="any" class="answer-input" placeholder="x = ?" style="width: 150px; font-size: 22px;">
          </div>
        `;
      } else if (goal.type === 'equation_proof') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 28px; margin: 30px 0; padding: 25px; background: white; border: 3px solid #2c5f8d; border-radius: 12px; font-weight: 600;">
            ${exercise.equation}
          </div>
          <div style="margin-top: 25px;">
            <p style="font-size: 20px; margin-bottom: 10px;">Deine L√∂sung f√ºr x:</p>
            <input type="number" step="any" class="answer-input" id="proofSolution" placeholder="x = ?" style="width: 150px; font-size: 22px; margin-bottom: 20px;">
            
            <p style="font-size: 20px; margin-bottom: 10px; margin-top: 25px;">F√ºhre die Probe durch:</p>
            <textarea class="answer-textarea" id="proofText" placeholder="Setze deine L√∂sung in die Gleichung ein und rechne beide Seiten aus..." style="min-height: 120px;"></textarea>
          </div>
        `;
      } else if (goal.type === 'text_equations') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 20px; margin: 20px 0; padding: 25px; background: #f8f9fa; border-left: 5px solid #2c5f8d; border-radius: 8px; line-height: 1.8;">
            ${exercise.wordProblem}
          </div>
          <div style="margin-top: 25px;">
            <p style="font-size: 18px; margin-bottom: 10px;">1. Stelle die Gleichung auf:</p>
            <input type="text" class="answer-input" id="textEquation" placeholder="z.B. x/3 - x/4 = 7" style="width: 300px; font-size: 18px; margin-bottom: 20px;">
            
            <p style="font-size: 18px; margin-bottom: 10px; margin-top: 20px;">2. Deine L√∂sung f√ºr x:</p>
            <input type="number" step="any" class="answer-input" id="textSolution" placeholder="x = ?" style="width: 150px; font-size: 22px; margin-bottom: 20px;">
            
            <p style="font-size: 18px; margin-bottom: 10px; margin-top: 20px;">3. F√ºhre die Probe durch:</p>
            <textarea class="answer-textarea" id="textProof" placeholder="Setze deine L√∂sung ein und pr√ºfe..." style="min-height: 100px;"></textarea>
          </div>
        `;
      } else if (goal.type === 'final_game') {
        questionHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 80px; margin-bottom: 30px;">üéÆ</div>
            <h2 style="font-size: 42px; color: #2c5f8d; margin-bottom: 20px;">Abschlussspiel</h2>
            <p style="font-size: 24px; color: #666; margin-bottom: 30px;">Gl√ºckwunsch! Du hast alle Lernziele gemeistert!</p>
            <p style="font-size: 20px; color: #666;">Hier k√∂nntest du ein spannendes Abschlussspiel spielen.</p>
          </div>
        `;
        answerHTML = '';
      } else if (goal.type === 'simple_equations' || goal.type === 'bracket_equations' || 
          goal.type === 'fraction_equations') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 28px; margin: 30px 0; padding: 25px; background: white; border: 3px solid #2c5f8d; border-radius: 12px; font-weight: 600;">
            ${exercise.equation}
          </div>
          <div style="margin-top: 20px;">
            <p style="font-size: 20px; margin-bottom: 10px;">Deine L√∂sung f√ºr x:</p>
            <input type="number" class="answer-input" placeholder="x = ?" style="width: 150px; font-size: 22px;">
          </div>
        `;
      } else if (goal.type === 'word_equations') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 20px; margin: 20px 0; padding: 25px; background: #f8f9fa; border-left: 5px solid #2c5f8d; border-radius: 8px; line-height: 1.8;">
            ${exercise.wordProblem}
          </div>
          <div style="margin-top: 25px;">
            <p style="font-size: 18px; margin-bottom: 10px; color: #666;">Gleichung: <strong style="color: #2c5f8d;">${exercise.equation}</strong></p>
            <p style="font-size: 20px; margin-bottom: 10px; margin-top: 20px;">Deine L√∂sung f√ºr x:</p>
            <input type="number" class="answer-input" placeholder="x = ?" style="width: 150px; font-size: 22px;">
          </div>
        `;
      } else if (goal.type === 'decimal_stellenwert') {
        questionHTML = exercise.question;
        const numStr = exercise.number.toString();
        const parts = numStr.split('.');
        const wholePart = parts[0].padStart(6, '0');
        const decimalPart = (parts[1] || '').padEnd(3, '0');
        
        answerHTML = `
          <div class="number-box" style="margin: 20px 0; font-size: 32px;">${formatDecimal(exercise.number)}</div>
          <table class="stellenwert-table">
            <thead>
              <tr>
                <th>HT</th><th>ZT</th><th>T</th><th>H</th><th>Z</th><th>E</th><th class="comma-col">,</th><th>z</th><th>h</th><th>t</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="whole-5"></td>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="whole-4"></td>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="whole-3"></td>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="whole-2"></td>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="whole-1"></td>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="whole-0"></td>
                <td style="background: #f0ad4e; font-size: 24px;">,</td>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="decimal-0"></td>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="decimal-1"></td>
                <td><input type="text" maxlength="1" class="stellenwert-input" data-place="decimal-2"></td>
              </tr>
            </tbody>
          </table>
        `;
      } else if (goal.type === 'decimal_ordering') {
        questionHTML = exercise.question;
        answerHTML = '<div class="number-grid">';
        exercise.numbers.forEach(num => {
          answerHTML += `<div class="number-box">${formatDecimal(num)}</div>`;
        });
        answerHTML += '</div>';
        answerHTML += '<p style="margin-top: 20px;">Ordne von klein nach gro√ü mit &lt;:</p>';
        answerHTML += '<div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">';
        exercise.numbers.forEach((_, i) => {
          answerHTML += `<input type="text" class="answer-input" placeholder="Zahl">`;
          if (i < exercise.numbers.length - 1) {
            answerHTML += '<span style="font-size: 24px; font-weight: bold;">&lt;</span>';
          }
        });
        answerHTML += '</div>';
      } else if (goal.type === 'decimal_place_value') {
        questionHTML = exercise.question.replace(exercise.number, formatDecimal(exercise.number));
        const placeNames = ['M', 'HT', 'ZT', 'T', 'H', 'Z', 'E', 'z', 'h', 't'];
        answerHTML = `
          <div style="margin: 20px 0;">
            <p style="font-size: 20px; margin-bottom: 15px;">W√§hle den richtigen Stellenwert:</p>
            <div style="display: flex; gap: 8px; flex-wrap: nowrap; justify-content: center;">
              ${placeNames.map(key => 
                `<button class="topic-button" style="padding: 10px 16px; font-size: 16px; min-width: 50px;" onclick="selectPlaceValue('${key}')">${key}</button>`
              ).join('')}
            </div>
            <input type="hidden" id="placeValueAnswer" value="">
          </div>
        `;
      } else if (goal.type === 'decimal_numberline_mark' || goal.type === 'decimal_numberline_read') {
        questionHTML = exercise.question;
        const isMarkExercise = (goal.type === 'decimal_numberline_mark');
        const numbersToShow = isMarkExercise ? exercise.numbers : [];
        const markedNumbers = isMarkExercise ? [] : exercise.markedNumbers;
        
        const steps = Math.round((exercise.max - exercise.min) / exercise.step);
        let markersHTML = '';
        
        const level = Math.floor(currentExerciseIndex / EXERCISES_PER_LEVEL);
        let labelFrequency;
        if (level === 0) labelFrequency = 1;
        else if (level === 1) labelFrequency = 2;
        else if (level === 2) labelFrequency = 5;
        else if (level === 3 || level === 4) labelFrequency = 10;
        else labelFrequency = steps;
        
        for (let i = 0; i <= steps; i++) {
          const value = parseFloat((exercise.min + (i * exercise.step)).toFixed(2));
          const percentage = 5 + (i / steps) * 90;
          const showLabel = (i === 0 || i === steps || (i % labelFrequency === 0 && labelFrequency < steps));
          
          const isMarked = markedNumbers.includes(value);
          
          markersHTML += `
            <div class="zahlenstrahl-marker" style="left: ${percentage}%;"></div>
            ${showLabel ? `<div class="zahlenstrahl-label" style="left: ${percentage}%;">${value}</div>` : ''}
            ${isMarkExercise ? 
              `<div class="zahlenstrahl-clickable" data-value="${value}" style="left: ${percentage}%;"></div>` :
              (isMarked ? `<div class="zahlenstrahl-clickable marked" data-value="${value}" style="left: ${percentage}%;"><div class="zahlenstrahl-x">‚úó</div></div>` : '')
            }
          `;
        }
        
        if (isMarkExercise) {
          answerHTML = `
            <div style="margin: 20px 0; font-size: 20px;">
              <strong>Markiere folgende Dezimalzahlen:</strong> <span style="color: #2c5f8d; font-weight: 700;">${numbersToShow.map(n => formatDecimal(n)).join(', ')}</span>
            </div>
            <div class="zahlenstrahl" id="zahlenstrahl">
              <div class="zahlenstrahl-line"></div>
              ${markersHTML}
            </div>
            <p style="color: #666; font-style: italic; margin-top: 10px;">
              Klicke auf die Markierungen auf dem Zahlenstrahl.
            </p>
          `;
          
          setTimeout(() => {
            const clickables = document.querySelectorAll('.zahlenstrahl-clickable');
            clickables.forEach(clickable => {
              clickable.onclick = function() {
                if (this.classList.contains('marked')) {
                  this.classList.remove('marked');
                  const existingX = this.querySelector('.zahlenstrahl-x');
                  if (existingX) existingX.remove();
                } else {
                  this.classList.add('marked');
                  const xMark = document.createElement('div');
                  xMark.className = 'zahlenstrahl-x';
                  xMark.textContent = '‚úó';
                  this.appendChild(xMark);
                }
              };
            });
          }, 100);
        } else {
          answerHTML = `
            <div style="margin: 20px 0; font-size: 20px;">
              <strong>Lies die markierten Dezimalzahlen ab:</strong>
            </div>
            <div class="zahlenstrahl" id="zahlenstrahl">
              <div class="zahlenstrahl-line"></div>
              ${markersHTML}
            </div>
            <div style="margin-top: 20px;">
              <p>Trage die Zahlen ein (getrennt durch Semikolon):</p>
              <input type="text" class="answer-input" style="width: 300px;" placeholder="z.B. 0,5; 1,2; 2,3" id="numberlineReadInput">
            </div>
          `;
        }
      } else if (goal.type === 'decimal_rounding') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 24px; margin: 20px 0;">
            <strong>${formatDecimal(exercise.number)}</strong> (auf ${exercise.roundTo}) ‚âà 
            <input type="text" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
          </div>
        `;
      } else if (goal.type === 'money_conversion') {
        questionHTML = exercise.question;
        if (exercise.toDecimal) {
          answerHTML = `
            <div style="font-size: 24px; margin: 20px 0;">
              <strong>${exercise.euros}‚Ç¨ ${exercise.cents}c</strong> = 
              <input type="text" class="answer-input" placeholder="‚Ç¨" style="width: 150px;"> ‚Ç¨
            </div>
          `;
        } else {
          answerHTML = `
            <div style="font-size: 24px; margin: 20px 0;">
              <strong>${formatDecimal(exercise.decimal)}‚Ç¨</strong> = 
              <input type="number" class="answer-input" placeholder="‚Ç¨" style="width: 100px;"> ‚Ç¨ 
              <input type="number" class="answer-input" placeholder="c" style="width: 100px;"> c
            </div>
          `;
        }
      } else if (goal.type === 'decimal_alignment') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 24px; margin: 20px 0;">
            <strong>${formatDecimal(exercise.num1)} ${exercise.operation} ${formatDecimal(exercise.num2)}</strong>
          </div>
          <div style="margin-top: 20px;">
            <p>Schreibe die Rechnung stellenwertrichtig auf (Komma unter Komma):</p>
            <div class="calculation-display" style="white-space: pre; text-align: center;">
              <input type="text" style="width: 200px; text-align: right; font-family: 'Courier New', monospace; font-size: 20px; margin-bottom: 5px; display: block; margin-left: auto; margin-right: auto;" placeholder="erste Zahl" id="align1">
              <div style="text-align: center; margin: 5px 0;">${exercise.operation}</div>
              <input type="text" style="width: 200px; text-align: right; font-family: 'Courier New', monospace; font-size: 20px; border-top: 2px solid #333; margin-top: 5px; display: block; margin-left: auto; margin-right: auto;" placeholder="zweite Zahl" id="align2">
            </div>
            <p style="font-style: italic; color: #666; margin-top: 10px;">Tipp: Achte darauf, dass die Kommas genau untereinander stehen!</p>
          </div>
        `;
      } else if (goal.type === 'decimal_addition' || goal.type === 'decimal_subtraction') {
        const operation = goal.type === 'decimal_addition' ? '+' : '-';
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 24px; margin: 20px 0;">
            <strong>${formatDecimal(exercise.num1)} ${operation} ${formatDecimal(exercise.num2)}</strong> = 
            <input type="text" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
          </div>
        `;
      } else if (goal.type === 'decimal_multiply_natural' || goal.type === 'decimal_multiply_decimal') {
        questionHTML = exercise.question;
        const num1Display = typeof exercise.num1 === 'number' && exercise.num1 % 1 !== 0 ? formatDecimal(exercise.num1) : exercise.num1;
        const num2Display = typeof exercise.num2 === 'number' && exercise.num2 % 1 !== 0 ? formatDecimal(exercise.num2) : exercise.num2;
        answerHTML = `
          <div style="font-size: 24px; margin: 20px 0;">
            <strong>${num1Display} √ó ${num2Display}</strong> = 
            <input type="text" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
          </div>
        `;
      } else if (goal.type === 'decimal_multiply_powers') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 24px; margin: 20px 0;">
            <strong>${formatDecimal(exercise.number)} √ó ${exercise.power}</strong> = 
            <input type="text" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
          </div>
        `;
      } else if (goal.type === 'decimal_divide_powers') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 24px; margin: 20px 0;">
            <strong>${formatDecimal(exercise.number)} √∑ ${exercise.power}</strong> = 
            <input type="text" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
          </div>
        `;
      } else if (goal.type === 'natural_divide_decimal') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 24px; margin: 20px 0;">
            <strong>${exercise.dividend} √∑ ${exercise.divisor}</strong> = 
            <input type="text" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
          </div>
        `;
      } else if (goal.type === 'decimal_divide_natural') {
        questionHTML = exercise.question;
        answerHTML = `
          <div style="font-size: 24px; margin: 20px 0;">
            <strong>${formatDecimal(exercise.decimal)} √∑ ${exercise.divisor}</strong> = 
            <input type="text" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
          </div>
        `;
      } else {
        // Original natural number exercises display logic
        switch(goal.type) {
          case 'ordering':
            questionHTML = exercise.question;
            answerHTML = '<div class="number-grid">';
            exercise.numbers.forEach(num => {
              answerHTML += `<div class="number-box">${num}</div>`;
            });
            answerHTML += '</div>';
            answerHTML += '<p style="margin-top: 20px;">Ordne von klein nach gro√ü mit &lt;:</p>';
            answerHTML += '<div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">';
            exercise.numbers.forEach((_, i) => {
              answerHTML += `<input type="number" class="answer-input" placeholder="Zahl">`;
              if (i < exercise.numbers.length - 1) {
                answerHTML += '<span style="font-size: 24px; font-weight: bold;">&lt;</span>';
              }
            });
            answerHTML += '</div>';
            break;
            
          case 'predecessor':
            questionHTML = exercise.question;
            answerHTML = `
              <div style="display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap;">
                <input type="number" class="answer-input" placeholder="Vorg√§nger">
                <div class="number-box">${exercise.number}</div>
                <input type="number" class="answer-input" placeholder="Nachfolger">
              </div>
            `;
            break;
            
          case 'stellenwert':
            questionHTML = exercise.question;
            const numStr = exercise.number.toString().padStart(7, '0');
            answerHTML = `
              <div class="number-box" style="margin: 20px 0; font-size: 32px;">${exercise.number}</div>
              <table class="stellenwert-table">
                <thead>
                  <tr>
                    <th>M</th><th>HT</th><th>ZT</th><th>T</th><th>H</th><th>Z</th><th>E</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><input type="text" maxlength="1" class="stellenwert-input" data-place="6"></td>
                    <td><input type="text" maxlength="1" class="stellenwert-input" data-place="5"></td>
                    <td><input type="text" maxlength="1" class="stellenwert-input" data-place="4"></td>
                    <td><input type="text" maxlength="1" class="stellenwert-input" data-place="3"></td>
                    <td><input type="text" maxlength="1" class="stellenwert-input" data-place="2"></td>
                    <td><input type="text" maxlength="1" class="stellenwert-input" data-place="1"></td>
                    <td><input type="text" maxlength="1" class="stellenwert-input" data-place="0"></td>
                  </tr>
                </tbody>
              </table>
            `;
            break;
            
          case 'rounding':
            questionHTML = exercise.question;
            answerHTML = `
              <div style="font-size: 24px; margin: 20px 0;">
                <strong>${exercise.number}</strong> (${exercise.place}) ‚âà 
                <input type="number" class="answer-input" placeholder="Ergebnis" style="width: 150px;">
              </div>
            `;
            break;
            
          case 'definition':
            questionHTML = exercise.question;
            answerHTML = `<textarea class="answer-textarea" placeholder="Schreibe deine Antwort hier..."></textarea>`;
            break;
            
          case 'numberline':
            questionHTML = exercise.question;
            const steps = (exercise.max - exercise.min) / exercise.step;
            let markersHTML = '';
            
            const level = Math.floor(currentExerciseIndex / EXERCISES_PER_LEVEL);
            let labelFrequency;
            if (level === 0) {
              labelFrequency = 1;
            } else if (level === 1) {
              labelFrequency = 2;
            } else if (level === 2) {
              labelFrequency = 5;
            } else if (level === 3 || level === 4) {
              labelFrequency = 10;
            } else {
              labelFrequency = steps;
            }
            
            for (let i = 0; i <= steps; i++) {
              const value = exercise.min + (i * exercise.step);
              const percentage = 5 + (i / steps) * 90;
              const showLabel = (i === 0 || i === steps || (i % labelFrequency === 0 && labelFrequency < steps));
              
              markersHTML += `
                <div class="zahlenstrahl-marker" style="left: ${percentage}%;"></div>
                ${showLabel ? `<div class="zahlenstrahl-label" style="left: ${percentage}%;">${value}</div>` : ''}
                <div class="zahlenstrahl-clickable" data-value="${value}" style="left: ${percentage}%;"></div>
              `;
            }
            
            answerHTML = `
              <div style="margin: 20px 0; font-size: 20px;">
                <strong>Markiere folgende Zahlen:</strong> <span style="color: #2c5f8d; font-weight: 700;">${exercise.numbers.join(', ')}</span>
              </div>
              <div class="zahlenstrahl" id="zahlenstrahl">
                <div class="zahlenstrahl-line"></div>
                ${markersHTML}
              </div>
              <p style="color: #666; font-style: italic; margin-top: 10px;">
                Klicke auf die Markierungen auf dem Zahlenstrahl.
              </p>
            `;
            
            setTimeout(() => {
              const clickables = document.querySelectorAll('.zahlenstrahl-clickable');
              clickables.forEach(clickable => {
                clickable.onclick = function() {
                  if (this.classList.contains('marked')) {
                    this.classList.remove('marked');
                    const existingX = this.querySelector('.zahlenstrahl-x');
                    if (existingX) existingX.remove();
                  } else {
                    this.classList.add('marked');
                    const xMark = document.createElement('div');
                    xMark.className = 'zahlenstrahl-x';
                    xMark.textContent = '‚úó';
                    this.appendChild(xMark);
                  }
                };
              });
            }, 100);
            break;
        }
      }
      
      document.getElementById('questionText').innerHTML = questionHTML;
      document.getElementById('answerArea').innerHTML = answerHTML;
    }

    window.selectPlaceValue = function(value) {
      document.getElementById('placeValueAnswer').value = value;
      const buttons = document.querySelectorAll('.answer-area button');
      buttons.forEach(btn => btn.style.background = 'linear-gradient(135deg, #2c5f8d 0%, #4a8fc7 100%)');
      event.target.style.background = '#5cb85c';
    };

    function toggleTip() {
      const tipBox = document.getElementById('tipBox');
      tipBox.classList.toggle('show');
    }

    // Helper function to parse user input with comma
    function parseUserDecimal(input) {
      if (!input) return NaN;
      const normalized = input.toString().replace(',', '.');
      return parseFloat(normalized);
    }

    function checkAnswer() {
      const goal = learningGoals[currentTopic][currentGoalIndex];
      const exercise = currentExercises[currentExerciseIndex];
      let isCorrect = false;
      
      attemptCount++;
      
      // Br√ºche check logic
      if (goal.type === 'fraction_parts') {
        if (exercise.isExplanation) {
          // Explanation page - always correct
          isCorrect = true;
        } else {
          // Matching task page
          const topSelect = document.getElementById('topSelect');
          const middleSelect = document.getElementById('middleSelect');
          const bottomSelect = document.getElementById('bottomSelect');
          
          if (!topSelect || !middleSelect || !bottomSelect) {
            handleFeedback(false, exercise, goal.type);
            return;
          }
          
          const userTop = topSelect.value;
          const userMiddle = middleSelect.value;
          const userBottom = bottomSelect.value;
          
          isCorrect = (userTop === exercise.solution.top && 
                       userMiddle === exercise.solution.middle && 
                       userBottom === exercise.solution.bottom);
        }
      } else if (goal.type === 'fraction_visual') {
        const numInput = document.getElementById('numerator');
        const denInput = document.getElementById('denominator');
        
        if (!numInput || !denInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(numInput.value);
        const userDen = parseInt(denInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_types') {
        const dropZones = document.querySelectorAll('.drop-zone');
        let allCorrect = true;
        
        dropZones.forEach(zone => {
          const category = zone.getAttribute('data-category');
          const cardsInZone = zone.querySelectorAll('.fraction-card');
          
          cardsInZone.forEach(card => {
            const cardType = card.getAttribute('data-type');
            if (cardType !== category) {
              allCorrect = false;
            }
          });
        });
        
        // Check that all cards are placed
        const unplacedCards = document.querySelectorAll('#fractionCards .fraction-card');
        if (unplacedCards.length > 0) {
          allCorrect = false;
        }
        
        isCorrect = allCorrect;
        
      } else if (goal.type === 'fraction_expand') {
        const newNumInput = document.getElementById('newNum');
        const newDenInput = document.getElementById('newDen');
        
        if (!newNumInput || !newDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(newNumInput.value);
        const userDen = parseInt(newDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_reduce') {
        const reducedNumInput = document.getElementById('reducedNum');
        const reducedDenInput = document.getElementById('reducedDen');
        
        if (!reducedNumInput || !reducedDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(reducedNumInput.value);
        const userDen = parseInt(reducedDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_add_same' || goal.type === 'fraction_subtract_same') {
        const resultNumInput = document.getElementById('resultNum');
        const resultDenInput = document.getElementById('resultDen');
        
        if (!resultNumInput || !resultDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(resultNumInput.value);
        const userDen = parseInt(resultDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_add_different' || goal.type === 'fraction_subtract_different') {
        const step1Inputs = [
          document.getElementById('step1_num1'),
          document.getElementById('step1_den1'),
          document.getElementById('step1_num2'),
          document.getElementById('step1_den2')
        ];
        const resultNumInput = document.getElementById('resultNum');
        const resultDenInput = document.getElementById('resultDen');
        
        if (step1Inputs.some(inp => !inp) || !resultNumInput || !resultDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        // Check Step 1: Common denominator
        const userStep1Num1 = parseInt(step1Inputs[0].value);
        const userStep1Den1 = parseInt(step1Inputs[1].value);
        const userStep1Num2 = parseInt(step1Inputs[2].value);
        const userStep1Den2 = parseInt(step1Inputs[3].value);
        
        const expandedNum1 = exercise.num1 * (exercise.commonDen / exercise.den1);
        const expandedNum2 = exercise.num2 * (exercise.commonDen / exercise.den2);
        
        const step1Correct = (
          userStep1Num1 === expandedNum1 &&
          userStep1Den1 === exercise.commonDen &&
          userStep1Num2 === expandedNum2 &&
          userStep1Den2 === exercise.commonDen
        );
        
        // Check Step 2: Final result
        const userNum = parseInt(resultNumInput.value);
        const userDen = parseInt(resultDenInput.value);
        const step2Correct = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
        isCorrect = step1Correct && step2Correct;
        
        if (!isCorrect && !step1Correct) {
          // Give specific feedback about step 1
          attemptCount++;
          const feedbackBox = document.getElementById('feedbackBox');
          const feedbackTitle = document.getElementById('feedbackTitle');
          const feedbackContent = document.getElementById('feedbackContent');
          
          feedbackBox.classList.remove('correct', 'incorrect');
          feedbackBox.classList.add('show', 'incorrect');
          feedbackTitle.textContent = '‚úó Schritt 1 ist nicht korrekt';
          feedbackContent.innerHTML = `Der gemeinsame Nenner ist <strong>${exercise.commonDen}</strong>.<br>
            Erweitere jeden Bruch auf diesen Nenner:<br>
            ${exercise.num1}/${exercise.den1} = ${expandedNum1}/${exercise.commonDen}<br>
            ${exercise.num2}/${exercise.den2} = ${expandedNum2}/${exercise.commonDen}`;
          return;
        } else if (!isCorrect && !step2Correct) {
          // Step 1 correct but step 2 wrong
          attemptCount++;
          const feedbackBox = document.getElementById('feedbackBox');
          const feedbackTitle = document.getElementById('feedbackTitle');
          const feedbackContent = document.getElementById('feedbackContent');
          
          feedbackBox.classList.remove('correct', 'incorrect');
          feedbackBox.classList.add('show', 'incorrect');
          feedbackTitle.textContent = '‚úó Schritt 2 ist nicht korrekt';
          const operator = goal.type === 'fraction_add_different' ? '+' : '-';
          feedbackContent.innerHTML = `Schritt 1 ist richtig! ‚úì<br><br>
            F√ºr Schritt 2: Berechne ${expandedNum1}/${exercise.commonDen} ${operator} ${expandedNum2}/${exercise.commonDen}<br>
            Vergiss nicht zu k√ºrzen!`;
          return;
        }
        
      } else if (goal.type === 'fraction_three_operations') {
        const step1Inputs = [
          document.getElementById('step1_num1'),
          document.getElementById('step1_den1'),
          document.getElementById('step1_num2'),
          document.getElementById('step1_den2'),
          document.getElementById('step1_num3'),
          document.getElementById('step1_den3')
        ];
        const resultNumInput = document.getElementById('resultNum');
        const resultDenInput = document.getElementById('resultDen');
        
        if (step1Inputs.some(inp => !inp) || !resultNumInput || !resultDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        // Check Step 1: Common denominator
        const userStep1Num1 = parseInt(step1Inputs[0].value);
        const userStep1Den1 = parseInt(step1Inputs[1].value);
        const userStep1Num2 = parseInt(step1Inputs[2].value);
        const userStep1Den2 = parseInt(step1Inputs[3].value);
        const userStep1Num3 = parseInt(step1Inputs[4].value);
        const userStep1Den3 = parseInt(step1Inputs[5].value);
        
        const step1Correct = (
          userStep1Num1 === exercise.expanded1 &&
          userStep1Den1 === exercise.commonDen &&
          userStep1Num2 === exercise.expanded2 &&
          userStep1Den2 === exercise.commonDen &&
          userStep1Num3 === exercise.expanded3 &&
          userStep1Den3 === exercise.commonDen
        );
        
        // Check Step 2: Final result
        const userNum = parseInt(resultNumInput.value);
        const userDen = parseInt(resultDenInput.value);
        const step2Correct = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
        isCorrect = step1Correct && step2Correct;
        
        if (!isCorrect && !step1Correct) {
          // Give specific feedback about step 1
          attemptCount++;
          const feedbackBox = document.getElementById('feedbackBox');
          const feedbackTitle = document.getElementById('feedbackTitle');
          const feedbackContent = document.getElementById('feedbackContent');
          
          feedbackBox.classList.remove('correct', 'incorrect');
          feedbackBox.classList.add('show', 'incorrect');
          feedbackTitle.textContent = '‚úó Schritt 1 ist nicht korrekt';
          feedbackContent.innerHTML = `Der gemeinsame Nenner ist <strong>${exercise.commonDen}</strong>.<br>
            Erweitere jeden Bruch auf diesen Nenner:<br>
            ${exercise.num1}/${exercise.den1} = ${exercise.expanded1}/${exercise.commonDen}<br>
            ${exercise.num2}/${exercise.den2} = ${exercise.expanded2}/${exercise.commonDen}<br>
            ${exercise.num3}/${exercise.den3} = ${exercise.expanded3}/${exercise.commonDen}`;
          return;
        } else if (!isCorrect && !step2Correct) {
          // Step 1 correct but step 2 wrong
          attemptCount++;
          const feedbackBox = document.getElementById('feedbackBox');
          const feedbackTitle = document.getElementById('feedbackTitle');
          const feedbackContent = document.getElementById('feedbackContent');
          
          feedbackBox.classList.remove('correct', 'incorrect');
          feedbackBox.classList.add('show', 'incorrect');
          feedbackTitle.textContent = '‚úó Schritt 2 ist nicht korrekt';
          feedbackContent.innerHTML = `Schritt 1 ist richtig! ‚úì<br><br>
            F√ºr Schritt 2: Berechne ${exercise.expanded1}/${exercise.commonDen} ${exercise.operation1} ${exercise.expanded2}/${exercise.commonDen} ${exercise.operation2} ${exercise.expanded3}/${exercise.commonDen}<br>
            Vergiss nicht zu k√ºrzen!`;
          return;
        }
        
      } else if (goal.type === 'fraction_to_decimal') {
        const input = document.querySelector('#answerArea input[type="text"]');
        
        if (!input || !input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userAnswer = parseUserDecimal(input.value);
        
        isCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - exercise.solution) < 0.001;
        
      } else if (goal.type === 'decimal_to_fraction') {
        const fracNumInput = document.getElementById('fracNum');
        const fracDenInput = document.getElementById('fracDen');
        
        if (!fracNumInput || !fracDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(fracNumInput.value);
        const userDen = parseInt(fracDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'mixed_to_improper') {
        const impNumInput = document.getElementById('impNum');
        const impDenInput = document.getElementById('impDen');
        
        if (!impNumInput || !impDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(impNumInput.value);
        const userDen = parseInt(impDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'mixed_addition' || goal.type === 'mixed_subtraction') {
        const wholeInput = document.getElementById('wholeResult');
        const numInput = document.getElementById('numResult');
        const denInput = document.getElementById('denResult');
        
        if (!wholeInput || !numInput || !denInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userWhole = parseInt(wholeInput.value) || 0;
        const userNum = parseInt(numInput.value) || 0;
        const userDen = parseInt(denInput.value) || 1;
        
        isCorrect = (userWhole === exercise.solution.whole && 
                     userNum === exercise.solution.num && 
                     userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_multiply') {
        const resultNumInput = document.getElementById('resultNum');
        const resultDenInput = document.getElementById('resultDen');
        
        if (!resultNumInput || !resultDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(resultNumInput.value);
        const userDen = parseInt(resultDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_multiply_natural') {
        const input = document.getElementById('mixedResult');
        
        if (!input || !input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userInput = input.value.trim();
        
        // Parse mixed number or improper fraction
        let userWhole = 0, userNum = 0, userDen = 1;
        
        if (userInput.includes(' ')) {
          // Mixed number format: "2 3/4"
          const parts = userInput.split(' ');
          userWhole = parseInt(parts[0]) || 0;
          if (parts[1] && parts[1].includes('/')) {
            const fracParts = parts[1].split('/');
            userNum = parseInt(fracParts[0]) || 0;
            userDen = parseInt(fracParts[1]) || 1;
          }
        } else if (userInput.includes('/')) {
          // Improper fraction: "11/4"
          const fracParts = userInput.split('/');
          userNum = parseInt(fracParts[0]) || 0;
          userDen = parseInt(fracParts[1]) || 1;
        } else {
          // Whole number
          userWhole = parseInt(userInput) || 0;
        }
        
        // Convert user answer to improper fraction for comparison
        const userImproper = userWhole * userDen + userNum;
        const userFraction = reduceFraction(userImproper, userDen);
        
        // Compare with solution (which can be mixed or improper)
        let solutionNum, solutionDen;
        if (exercise.solution.whole !== undefined) {
          const solImproper = mixedToImproper(exercise.solution.whole, exercise.solution.num, exercise.solution.den);
          solutionNum = solImproper.num;
          solutionDen = solImproper.den;
        } else {
          solutionNum = exercise.solution.num;
          solutionDen = exercise.solution.den;
        }
        
        isCorrect = (userFraction.num === solutionNum && userFraction.den === solutionDen);
        
      } else if (goal.type === 'mixed_multiply') {
        const resultNumInput = document.getElementById('resultNum');
        const resultDenInput = document.getElementById('resultDen');
        
        if (!resultNumInput || !resultDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(resultNumInput.value);
        const userDen = parseInt(resultDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_reciprocal') {
        const recipNumInput = document.getElementById('recipNum');
        const recipDenInput = document.getElementById('recipDen');
        
        if (!recipNumInput || !recipDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(recipNumInput.value);
        const userDen = parseInt(recipDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_divide') {
        const resultNumInput = document.getElementById('resultNum');
        const resultDenInput = document.getElementById('resultDen');
        
        if (!resultNumInput || !resultDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(resultNumInput.value);
        const userDen = parseInt(resultDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_divide_natural') {
        const resultNumInput = document.getElementById('resultNum');
        const resultDenInput = document.getElementById('resultDen');
        
        if (!resultNumInput || !resultDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(resultNumInput.value);
        const userDen = parseInt(resultDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'mixed_divide') {
        const resultNumInput = document.getElementById('resultNum');
        const resultDenInput = document.getElementById('resultDen');
        
        if (!resultNumInput || !resultDenInput) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userNum = parseInt(resultNumInput.value);
        const userDen = parseInt(resultDenInput.value);
        
        isCorrect = (userNum === exercise.solution.num && userDen === exercise.solution.den);
        
      } else if (goal.type === 'fraction_order') {
        const input = document.querySelector('#answerArea input[type="text"]');
        
        if (!input || !input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userAnswer = parseUserDecimal(input.value);
        const expectedAnswer = exercise.whole + (exercise.num1 / exercise.den1) + (exercise.num2 * exercise.num3) / (exercise.den2 * exercise.den3);
        
        isCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - expectedAnswer) < 0.01;
        
      } else if (goal.type === 'fraction_word_problems') {
        const textarea = document.getElementById('wordAnswer');
        
        if (!textarea || !textarea.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        
        const userText = textarea.value.trim().toLowerCase();
        
        // Check if user's answer contains the expected numbers
        if (exercise.solution.girls !== undefined) {
          isCorrect = userText.includes(exercise.solution.girls.toString()) && 
                      userText.includes(exercise.solution.boys.toString());
        } else if (exercise.solution.amount !== undefined) {
          isCorrect = userText.includes(exercise.solution.amount.toString());
        } else if (exercise.solution.num !== undefined) {
          isCorrect = userText.includes(exercise.solution.num.toString()) && 
                      userText.includes(exercise.solution.den.toString());
        } else {
          isCorrect = userText.length > 20;
        }
        
      } else if (goal.type === 'one_step_equations' || goal.type === 'simple_multi_step_equations' || 
          goal.type === 'complex_multi_step_equations' || goal.type === 'quadratic_equations') {
        const input = document.querySelector('#answerArea input');
        if (!input || !input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const userAnswer = parseUserDecimal(input.value);
        const expectedAnswer = typeof exercise.solution === 'number' ? exercise.solution : parseFloat(exercise.solution);
        isCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - expectedAnswer) < 0.01;
      } else if (goal.type === 'equation_proof') {
        const solutionInput = document.getElementById('proofSolution');
        const proofInput = document.getElementById('proofText');
        if (!solutionInput || !proofInput || !solutionInput.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const userAnswer = parseUserDecimal(solutionInput.value);
        const expectedAnswer = typeof exercise.solution === 'number' ? exercise.solution : parseFloat(exercise.solution);
        const proofText = proofInput.value.trim();
        
        // Check both solution and that proof field has content
        isCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - expectedAnswer) < 0.01 && proofText.length > 5;
      } else if (goal.type === 'text_equations') {
        const solutionInput = document.getElementById('textSolution');
        if (!solutionInput || !solutionInput.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const userAnswer = parseUserDecimal(solutionInput.value);
        const expectedAnswer = typeof exercise.solution === 'number' ? exercise.solution : parseFloat(exercise.solution);
        
        // For text equations, just check the solution (equation setup and proof are optional)
        isCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - expectedAnswer) < 0.01;
      } else if (goal.type === 'final_game') {
        isCorrect = true; // Placeholder always correct
      } else if (goal.type === 'decimal_stellenwert') {
        const inputs = document.querySelectorAll('.stellenwert-input');
        const numStr = exercise.number.toString();
        const parts = numStr.split('.');
        const wholePart = parts[0].padStart(6, '0');
        const decimalPart = (parts[1] || '').padEnd(3, '0');
        
        isCorrect = true;
        inputs.forEach(input => {
          const place = input.getAttribute('data-place');
          let expectedDigit;
          
          if (place.startsWith('whole')) {
            const index = parseInt(place.split('-')[1]);
            expectedDigit = wholePart[5 - index];
          } else {
            const index = parseInt(place.split('-')[1]);
            expectedDigit = decimalPart[index];
          }
          
          const userValue = input.value.trim();
          
          if (expectedDigit === '0') {
            if (userValue !== '' && userValue !== '0') {
              isCorrect = false;
            }
          } else {
            if (userValue !== expectedDigit) {
              isCorrect = false;
            }
          }
        });
      } else if (goal.type === 'decimal_ordering') {
        const inputs = document.querySelectorAll('#answerArea input[type="text"]');
        if (inputs.length === 0) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const userAnswers = Array.from(inputs).map(inp => parseUserDecimal(inp.value));
        if (userAnswers.some(n => isNaN(n))) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const expectedSorted = exercise.solution.map(n => parseFloat(n.toFixed(2)));
        const userSorted = userAnswers.map(n => parseFloat(n.toFixed(2)));
        isCorrect = JSON.stringify(userSorted) === JSON.stringify(expectedSorted);
      } else if (goal.type === 'decimal_place_value') {
        const userAnswer = document.getElementById('placeValueAnswer').value;
        if (!userAnswer) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        isCorrect = (userAnswer === exercise.solution);
      } else if (goal.type === 'decimal_numberline_mark') {
        const markedElements = document.querySelectorAll('#zahlenstrahl .zahlenstrahl-clickable.marked');
        const markedValues = Array.from(markedElements).map(el => parseFloat(el.getAttribute('data-value')));
        const sortedMarked = [...markedValues].sort((a, b) => a - b).map(n => parseFloat(n.toFixed(2)));
        const sortedExpected = [...exercise.numbers].sort((a, b) => a - b).map(n => parseFloat(n.toFixed(2)));
        isCorrect = JSON.stringify(sortedMarked) === JSON.stringify(sortedExpected);
      } else if (goal.type === 'decimal_numberline_read') {
        const input = document.getElementById('numberlineReadInput');
        if (!input || !input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const userNumbers = input.value.split(';').map(s => parseUserDecimal(s.trim())).filter(n => !isNaN(n)).sort((a, b) => a - b).map(n => parseFloat(n.toFixed(2)));
        const expectedNumbers = [...exercise.markedNumbers].sort((a, b) => a - b).map(n => parseFloat(n.toFixed(2)));
        isCorrect = JSON.stringify(userNumbers) === JSON.stringify(expectedNumbers);
      } else if (goal.type === 'decimal_rounding') {
        const input = document.querySelector('#answerArea input[type="text"]');
        if (!input || !input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const userAnswer = parseUserDecimal(input.value);
        isCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - exercise.solution) < 0.01;
      } else if (goal.type === 'money_conversion') {
        if (exercise.toDecimal) {
          const input = document.querySelector('#answerArea input[type="text"]');
          if (!input || !input.value.trim()) {
            handleFeedback(false, exercise, goal.type);
            return;
          }
          const userAnswer = parseUserDecimal(input.value);
          isCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - exercise.solution) < 0.01;
        } else {
          const inputs = document.querySelectorAll('#answerArea input[type="number"]');
          if (inputs.length < 2 || !inputs[0].value.trim() || !inputs[1].value.trim()) {
            handleFeedback(false, exercise, goal.type);
            return;
          }
          const userEuros = parseInt(inputs[0].value) || 0;
          const userCents = parseInt(inputs[1].value) || 0;
          isCorrect = (userEuros === exercise.solution.euros && userCents === exercise.solution.cents);
        }
      } else if (goal.type === 'decimal_alignment') {
        const align1Input = document.getElementById('align1');
        const align2Input = document.getElementById('align2');
        if (!align1Input || !align2Input || !align1Input.value.trim() || !align2Input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const align1 = align1Input.value.trim();
        const align2 = align2Input.value.trim();
        
        const commaIndex1 = align1.indexOf(',') !== -1 ? align1.indexOf(',') : align1.indexOf('.');
        const commaIndex2 = align2.indexOf(',') !== -1 ? align2.indexOf(',') : align2.indexOf('.');
        
        const num1Parsed = parseUserDecimal(align1);
        const num2Parsed = parseUserDecimal(align2);
        
        const alignedCorrectly = (commaIndex1 === commaIndex2) && commaIndex1 !== -1 && commaIndex2 !== -1;
        const numbersCorrect = !isNaN(num1Parsed) && !isNaN(num2Parsed) && 
                               Math.abs(num1Parsed - exercise.num1) < 0.01 && 
                               Math.abs(num2Parsed - exercise.num2) < 0.01;
        
        isCorrect = alignedCorrectly && numbersCorrect;
      } else if (goal.type === 'decimal_addition' || goal.type === 'decimal_subtraction' ||
                 goal.type === 'decimal_multiply_natural' || goal.type === 'decimal_multiply_decimal' ||
                 goal.type === 'decimal_multiply_powers' || goal.type === 'decimal_divide_powers' ||
                 goal.type === 'natural_divide_decimal' || goal.type === 'decimal_divide_natural') {
        const input = document.querySelector('#answerArea input[type="text"]');
        if (!input || !input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const userAnswer = parseUserDecimal(input.value);
        isCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - exercise.solution) < 0.01;
      } else if (goal.type === 'simple_equations' || goal.type === 'bracket_equations' || 
                 goal.type === 'fraction_equations' || goal.type === 'word_equations') {
        const input = document.querySelector('#answerArea input[type="number"]');
        if (!input || !input.value.trim()) {
          handleFeedback(false, exercise, goal.type);
          return;
        }
        const userAnswer = parseInt(input.value);
        isCorrect = !isNaN(userAnswer) && (userAnswer === exercise.solution);
      } else {
        // Original natural number checking logic
        switch(goal.type) {
          case 'ordering':
            const inputs = document.querySelectorAll('#answerArea input[type="number"]');
            if (inputs.length === 0) {
              handleFeedback(false, exercise, goal.type);
              return;
            }
            const userAnswers = Array.from(inputs).map(inp => parseInt(inp.value));
            if (userAnswers.some(n => isNaN(n))) {
              handleFeedback(false, exercise, goal.type);
              return;
            }
            isCorrect = JSON.stringify(userAnswers) === JSON.stringify(exercise.solution);
            break;
            
          case 'predecessor':
            const predInput = document.querySelectorAll('#answerArea input[type="number"]')[0];
            const succInput = document.querySelectorAll('#answerArea input[type="number"]')[1];
            if (!predInput || !succInput || !predInput.value.trim() || !succInput.value.trim()) {
              handleFeedback(false, exercise, goal.type);
              return;
            }
            const userPred = parseInt(predInput.value);
            const userSucc = parseInt(succInput.value);
            isCorrect = !isNaN(userPred) && !isNaN(userSucc) && (userPred === exercise.predecessor && userSucc === exercise.successor);
            break;
            
          case 'stellenwert':
            const stellInputs = document.querySelectorAll('.stellenwert-input');
            const numStr = exercise.number.toString().padStart(7, '0');
            isCorrect = true;
            stellInputs.forEach((input, idx) => {
              const expectedDigit = numStr[idx];
              const userValue = input.value.trim();
              if (expectedDigit === '0') {
                if (userValue !== '' && userValue !== '0') {
                  isCorrect = false;
                }
              } else {
                if (userValue !== expectedDigit) {
                  isCorrect = false;
                }
              }
            });
            break;
            
          case 'rounding':
            const roundInput = document.querySelector('#answerArea input[type="number"]');
            if (!roundInput || !roundInput.value.trim()) {
              handleFeedback(false, exercise, goal.type);
              return;
            }
            const userRound = parseInt(roundInput.value);
            isCorrect = !isNaN(userRound) && (userRound === exercise.solution);
            break;
            
          case 'definition':
            const textarea = document.querySelector('#answerArea textarea');
            if (!textarea) {
              handleFeedback(false, exercise, goal.type);
              return;
            }
            const userText = textarea.value.trim();
            isCorrect = userText.length > 10;
            break;
            
          case 'numberline':
            const markedElements = document.querySelectorAll('#zahlenstrahl .zahlenstrahl-clickable.marked');
            const markedValues = Array.from(markedElements).map(el => parseInt(el.getAttribute('data-value')));
            const sortedMarked = [...markedValues].sort((a, b) => a - b);
            const sortedExpected = [...exercise.numbers].sort((a, b) => a - b);
            isCorrect = JSON.stringify(sortedMarked) === JSON.stringify(sortedExpected);
            break;
        }
      }
      
      handleFeedback(isCorrect, exercise, goal.type);
    }

    function handleFeedback(isCorrect, exercise, exerciseType) {
      const feedbackBox = document.getElementById('feedbackBox');
      const feedbackTitle = document.getElementById('feedbackTitle');
      const feedbackContent = document.getElementById('feedbackContent');
      
      feedbackBox.classList.remove('correct', 'incorrect');
      feedbackBox.classList.add('show');
      
      if (isCorrect) {
        feedbackBox.classList.add('correct');
        feedbackTitle.textContent = '‚úì Richtig!';
        feedbackContent.innerHTML = 'Super gemacht! Du kannst zur n√§chsten Aufgabe.';
        
        const controls = document.querySelector('.exercise-controls');
        if (!document.getElementById('nextBtn')) {
          const nextBtn = document.createElement('button');
          nextBtn.id = 'nextBtn';
          nextBtn.className = 'next-button';
          nextBtn.textContent = 'Weiter ‚Üí';
          nextBtn.onclick = nextExercise;
          controls.appendChild(nextBtn);
        }
      } else {
        feedbackBox.classList.add('incorrect');
        
        if (attemptCount === 1) {
          feedbackTitle.textContent = '‚úó Leider falsch';
          feedbackContent.innerHTML = 'Versuche es noch einmal!';
        } else {
          feedbackTitle.textContent = '‚úó Leider falsch';
          feedbackContent.innerHTML = getSolutionText(exercise, exerciseType);
          feedbackContent.innerHTML += '<br><br><strong>Gib bitte die richtige L√∂sung ein, um fortzufahren.</strong>';
        }
      }
    }

    function getSolutionText(exercise, exerciseType) {
      switch(exerciseType) {
        // Br√ºche solutions
        case 'fraction_parts':
          if (exercise.isExplanation) {
            return ``;
          } else {
            return `<strong>Richtige L√∂sung:</strong><br>
              Oben steht der: <strong>Z√§hler</strong><br>
              In der Mitte ist der: <strong>Bruchstrich</strong><br>
              Unten steht der: <strong>Nenner</strong>`;
          }
          
        case 'fraction_visual':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.solution.num}/${exercise.solution.den} (${exercise.solution.num} von ${exercise.solution.den} Teilen sind eingef√§rbt)`;
          
        case 'fraction_types':
          const proper = exercise.fractions.filter(f => f.type === 'proper').map(f => formatFraction(f.num, f.den)).join(', ');
          const improper = exercise.fractions.filter(f => f.type === 'improper').map(f => formatFraction(f.num, f.den)).join(', ');
          const mixed = exercise.fractions.filter(f => f.type === 'mixed').map(f => formatMixedNumber(f.whole, f.num, f.den)).join(', ');
          return `<strong>Richtige L√∂sung:</strong><br>
            Echter Bruch: ${proper}<br>
            Unechter Bruch: ${improper}<br>
            Gemischte Zahl: ${mixed}`;
          
        case 'fraction_expand':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num}/${exercise.den} = ${exercise.solution.num}/${exercise.solution.den}<br>
            (Z√§hler und Nenner mit ${exercise.factor} multipliziert)`;
          
        case 'fraction_reduce':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num}/${exercise.den} = ${exercise.solution.num}/${exercise.solution.den}<br>
            (Gek√ºrzt durch den ggT ${gcd(exercise.num, exercise.den)})`;
          
        case 'fraction_add_same':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num1}/${exercise.den} + ${exercise.num2}/${exercise.den} = ${exercise.num1 + exercise.num2}/${exercise.den} = ${exercise.solution.num}/${exercise.solution.den}`;
          
        case 'fraction_subtract_same':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num1}/${exercise.den} - ${exercise.num2}/${exercise.den} = ${exercise.num1 - exercise.num2}/${exercise.den} = ${exercise.solution.num}/${exercise.solution.den}`;
          
        case 'fraction_add_different':
        case 'fraction_subtract_different':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.solution.num}/${exercise.solution.den}<br><br>
            <strong>L√∂sungsweg:</strong><br>${exercise.steps}`;
          
        case 'fraction_three_operations':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.solution.num}/${exercise.solution.den}<br>
            (Gemeinsamer Nenner: ${exercise.commonDen})`;
          
        case 'fraction_to_decimal':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num}/${exercise.den} = ${formatDecimal(exercise.solution)}<br>
            (${exercise.num} √∑ ${exercise.den} = ${exercise.solution})`;
          
        case 'decimal_to_fraction':
          return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(exercise.decimal)} = ${exercise.solution.num}/${exercise.solution.den}`;
          
        case 'mixed_to_improper':
          return `<strong>Richtige L√∂sung:</strong> ${formatMixedNumber(exercise.whole, exercise.num, exercise.den)} = ${exercise.solution.num}/${exercise.solution.den}<br>
            (${exercise.whole} √ó ${exercise.den} + ${exercise.num} = ${exercise.solution.num})`;
          
        case 'mixed_addition':
          return `<strong>Richtige L√∂sung:</strong> ${formatMixedNumber(exercise.solution.whole, exercise.solution.num, exercise.solution.den)}`;
          
        case 'mixed_subtraction':
          return `<strong>Richtige L√∂sung:</strong> Berechne die ganzen Zahlen und Br√ºche separat.`;
          
        case 'fraction_multiply':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num1}/${exercise.den1} √ó ${exercise.num2}/${exercise.den2} = ${exercise.num1 * exercise.num2}/${exercise.den1 * exercise.den2} = ${exercise.solution.num}/${exercise.solution.den}<br>
            (Z√§hler mal Z√§hler, Nenner mal Nenner, dann k√ºrzen)`;
          
        case 'fraction_multiply_natural':
          let solutionDisplay;
          if (exercise.solution.whole !== undefined) {
            solutionDisplay = formatMixedNumber(exercise.solution.whole, exercise.solution.num, exercise.solution.den);
          } else {
            solutionDisplay = formatFraction(exercise.solution.num, exercise.solution.den);
          }
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num}/${exercise.den} √ó ${exercise.natural} = ${solutionDisplay}<br>
            (${exercise.num} √ó ${exercise.natural} = ${exercise.num * exercise.natural}, dann k√ºrzen und ggf. in gemischte Zahl umwandeln)`;
          
        case 'mixed_multiply':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.solution.num}/${exercise.solution.den}<br>
            (Gemischte Zahl in unechten Bruch umwandeln: ${formatMixedNumber(exercise.whole1, exercise.num1, exercise.den1)} = ${exercise.whole1 * exercise.den1 + exercise.num1}/${exercise.den1}, dann multiplizieren)`;
          
        case 'fraction_reciprocal':
          const originalDisplay = exercise.den === 1 ? exercise.num.toString() : `${exercise.num}/${exercise.den}`;
          return `<strong>Richtige L√∂sung:</strong> Kehrwert von ${originalDisplay} = ${exercise.solution.num}/${exercise.solution.den}<br>
            (Z√§hler und Nenner werden vertauscht)`;
          
        case 'fraction_divide':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num1}/${exercise.den1} √∑ ${exercise.num2}/${exercise.den2} = ${exercise.solution.num}/${exercise.solution.den}<br>
            (Mit dem Kehrwert multiplizieren: ${exercise.num1}/${exercise.den1} √ó ${exercise.den2}/${exercise.num2})`;
          
        case 'fraction_divide_natural':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.num}/${exercise.den} √∑ ${exercise.natural} = ${exercise.solution.num}/${exercise.solution.den}<br>
            (Nenner mit ${exercise.natural} multiplizieren: ${exercise.num}/${exercise.den * exercise.natural}, dann k√ºrzen)`;
          
        case 'mixed_divide':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.solution.num}/${exercise.solution.den}<br>
            (Gemischte Zahl in unechten Bruch umwandeln, dann mit Kehrwert multiplizieren)`;
          
        case 'fraction_order':
          const mixedStr = formatMixedNumber(exercise.whole, exercise.num1, exercise.den1);
          const productFrac = `${exercise.num2 * exercise.num3}/${exercise.den2 * exercise.den3}`;
          const result = exercise.whole + (exercise.num1 / exercise.den1) + (exercise.num2 * exercise.num3) / (exercise.den2 * exercise.den3);
          return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(result)}<br><br>
            <strong>L√∂sungsweg (Punkt vor Strich!):</strong><br>
            1. Erst Multiplikation: ${exercise.num2}/${exercise.den2} √ó ${exercise.num3}/${exercise.den3} = ${productFrac}<br>
            2. Dann Addition: ${mixedStr} + ${productFrac} = ${formatDecimal(result)}`;
          
        case 'fraction_word_problems':
          let wordSolution = '<strong>Musterl√∂sung:</strong><br>';
          if (exercise.solution.girls !== undefined) {
            wordSolution += `M√§dchen: ${exercise.solution.girls}<br>Jungen: ${exercise.solution.boys}`;
          } else if (exercise.solution.amount !== undefined) {
            wordSolution += `Betrag: ${exercise.solution.amount}‚Ç¨`;
          } else if (exercise.solution.num !== undefined) {
            wordSolution += `Jede Person bekommt: ${exercise.solution.num}/${exercise.solution.den}`;
          }
          return wordSolution;
          
        // Gleichungen 4. Klasse MS solutions
        case 'one_step_equations':
        case 'simple_multi_step_equations':
        case 'complex_multi_step_equations':
          return `<strong>Richtige L√∂sung:</strong> x = ${exercise.solution}<br><br><strong>L√∂sungsweg:</strong><br><pre style="font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.8; background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${exercise.steps}</pre>`;
          
        case 'equation_proof':
          return `<strong>Richtige L√∂sung:</strong> x = ${exercise.solution}<br><br><strong>L√∂sungsweg:</strong><br><pre style="font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.8; background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${exercise.steps}</pre><br><strong>Probe:</strong><br><pre style="font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.8; background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${exercise.proof}</pre>`;
        
        case 'quadratic_equations':
          return `<strong>Richtige L√∂sung:</strong> x = ${exercise.solution}<br><br><strong>L√∂sungsweg:</strong><br><pre style="font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.8; background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${exercise.steps}</pre>`;
          
        case 'text_equations':
          return `<strong>Richtige Gleichung:</strong> ${exercise.equation}<br><strong>Richtige L√∂sung:</strong> x = ${exercise.solution}<br><br><strong>L√∂sungsweg:</strong><br><pre style="font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.8; background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${exercise.steps}</pre><br><strong>Probe:</strong><br><pre style="font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.8; background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${exercise.proof}</pre>`;
          
        case 'final_game':
          return ``;
          
        case 'decimal_stellenwert':
          const numStr = exercise.number.toString();
          const parts = numStr.split('.');
          const wholePart = parts[0].padStart(6, '0');
          const decimalPart = (parts[1] || '').padEnd(3, '0');
          return `<strong>Richtige L√∂sung:</strong> HT: ${wholePart[0]}, ZT: ${wholePart[1]}, T: ${wholePart[2]}, H: ${wholePart[3]}, Z: ${wholePart[4]}, E: ${wholePart[5]}, z: ${decimalPart[0]}, h: ${decimalPart[1]}, t: ${decimalPart[2]}`;
          
        case 'decimal_ordering':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.solution.map(n => formatDecimal(n)).join(' < ')}`;
          
        case 'decimal_place_value':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.solution}`;
          
        case 'decimal_numberline_mark':
          return `<strong>Richtige L√∂sung:</strong> Markiere die Zahlen ${exercise.numbers.map(n => formatDecimal(n)).join(', ')} auf dem Zahlenstrahl.`;
          
        case 'decimal_numberline_read':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.markedNumbers.map(n => formatDecimal(n)).join('; ')}`;
          
        case 'decimal_rounding':
          return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(exercise.number)} ‚âà ${formatDecimal(exercise.solution)}`;
          
        case 'money_conversion':
          if (exercise.toDecimal) {
            return `<strong>Richtige L√∂sung:</strong> ${exercise.euros}‚Ç¨ ${exercise.cents}c = ${formatDecimal(exercise.solution)}‚Ç¨`;
          } else {
            return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(exercise.decimal)}‚Ç¨ = ${exercise.solution.euros}‚Ç¨ ${exercise.solution.cents}c`;
          }
          
        case 'decimal_alignment':
          return `<strong>Richtige L√∂sung:</strong> Schreibe ${formatDecimal(exercise.num1)} und ${formatDecimal(exercise.num2)} so untereinander, dass die Kommas genau √ºbereinander stehen.`;
          
        case 'decimal_addition':
          return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(exercise.num1)} + ${formatDecimal(exercise.num2)} = ${formatDecimal(exercise.solution)}`;
          
        case 'decimal_subtraction':
          return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(exercise.num1)} - ${formatDecimal(exercise.num2)} = ${formatDecimal(exercise.solution)}`;
          
        case 'decimal_multiply_natural':
        case 'decimal_multiply_decimal':
          const num1Display = typeof exercise.num1 === 'number' && exercise.num1 % 1 !== 0 ? formatDecimal(exercise.num1) : exercise.num1;
          const num2Display = typeof exercise.num2 === 'number' && exercise.num2 % 1 !== 0 ? formatDecimal(exercise.num2) : exercise.num2;
          return `<strong>Richtige L√∂sung:</strong> ${num1Display} √ó ${num2Display} = ${formatDecimal(exercise.solution)}`;
          
        case 'decimal_multiply_powers':
          return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(exercise.number)} √ó ${exercise.power} = ${formatDecimal(exercise.solution)}`;
          
        case 'decimal_divide_powers':
          return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(exercise.number)} √∑ ${exercise.power} = ${formatDecimal(exercise.solution)}`;
          
        case 'natural_divide_decimal':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.dividend} √∑ ${exercise.divisor} = ${formatDecimal(exercise.solution)}`;
          
        case 'decimal_divide_natural':
          return `<strong>Richtige L√∂sung:</strong> ${formatDecimal(exercise.decimal)} √∑ ${exercise.divisor} = ${formatDecimal(exercise.solution)}`;
          
        // Gleichungen solutions
        case 'simple_equations':
        case 'bracket_equations':
        case 'fraction_equations':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.equation} ‚Üí x = ${exercise.solution}`;
          
        case 'word_equations':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.equation} ‚Üí x = ${exercise.solution}`;
          
        // Original natural number solutions
        case 'ordering':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.solution.join(' < ')}`;
          
        case 'predecessor':
          return `<strong>Richtige L√∂sung:</strong> Vorg√§nger: ${exercise.predecessor}, Nachfolger: ${exercise.successor}`;
          
        case 'stellenwert':
          const naturalNumStr = exercise.number.toString().padStart(7, '0');
          return `<strong>Richtige L√∂sung:</strong> M: ${naturalNumStr[0]}, HT: ${naturalNumStr[1]}, ZT: ${naturalNumStr[2]}, T: ${naturalNumStr[3]}, H: ${naturalNumStr[4]}, Z: ${naturalNumStr[5]}, E: ${naturalNumStr[6]}`;
          
        case 'rounding':
          return `<strong>Richtige L√∂sung:</strong> ${exercise.number} ‚âà ${exercise.solution}`;
          
        case 'definition':
          return `<strong>Musterl√∂sung:</strong> ${exercise.solution}`;
          
        case 'numberline':
          return `<strong>Richtige L√∂sung:</strong> Markiere die Zahlen ${exercise.numbers.join(', ')} auf dem Zahlenstrahl.`;
          
        default:
          return '';
      }
    }

    function nextExercise() {
      const nextBtn = document.getElementById('nextBtn');
      if (nextBtn) {
        nextBtn.remove();
      }
      
      if (currentExerciseIndex < currentExercises.length - 1) {
        currentExerciseIndex++;
        displayExercise();
      } else {
        showCompletionMessage();
      }
    }

    function showCompletionMessage() {
      const answerArea = document.getElementById('answerArea');
      answerArea.innerHTML = `
        <div style="text-align: center; padding: 40px; background: #d4edda; border-radius: 15px;">
          <div style="font-size: 64px; margin-bottom: 20px;">ÔøΩÔøΩÔøΩ</div>
          <h3 style="color: #155724; font-size: 28px; margin-bottom: 15px;">Gl√ºckwunsch!</h3>
          <p style="font-size: 20px; color: #155724;">Du hast alle 50 Aufgaben abgeschlossen!</p>
          <button class="new-button" onclick="startExercises(${currentGoalIndex})" style="margin-top: 20px;">
            Neue Aufgaben generieren
          </button>
        </div>
      `;
      document.getElementById('questionText').innerHTML = '';
    }

    function showCustomMessage(message, returnView) {
      const container = document.createElement('div');
      container.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 1000; text-align: center;';
      container.innerHTML = `
        <p style="font-size: 24px; color: #2c5f8d; margin-bottom: 20px;">${message}</p>
        <button class="back-button" onclick="this.parentElement.remove()">OK</button>
      `;
      document.body.appendChild(container);
    }

    function backToTopics() {
      currentView = 'topics';
      document.getElementById('exerciseView').classList.add('hidden');
      showLearningGoals(currentClass, classTopics[currentClass].indexOf(currentTopic));
    }

    function showMain() {
      currentView = 'main';
      document.getElementById('topicsView').classList.add('hidden');
      document.getElementById('exerciseView').classList.add('hidden');
      document.getElementById('mainView').classList.remove('hidden');
    }

    async function onConfigChange(config) {
      document.getElementById('mainTitle').textContent = config.main_title || defaultConfig.main_title;
      document.getElementById('class1Label').textContent = config.class_1_label || defaultConfig.class_1_label;
      document.getElementById('class2Label').textContent = config.class_2_label || defaultConfig.class_2_label;
      document.getElementById('class3Label').textContent = config.class_3_label || defaultConfig.class_3_label;
      document.getElementById('class4Label').textContent = config.class_4_label || defaultConfig.class_4_label;
      document.getElementById('dfkLabel').textContent = config.dfk_label || defaultConfig.dfk_label;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["main_title", config.main_title || defaultConfig.main_title],
        ["class_1_label", config.class_1_label || defaultConfig.class_1_label],
        ["class_2_label", config.class_2_label || defaultConfig.class_2_label],
        ["class_3_label", config.class_3_label || defaultConfig.class_3_label],
        ["class_4_label", config.class_4_label || defaultConfig.class_4_label],
        ["dfk_label", config.dfk_label || defaultConfig.dfk_label]
      ]);
    }

    // Initialize on page load
    window.addEventListener('load', function() {
      onConfigChange(defaultConfig);
      
      // Setup class card click handlers
      document.querySelectorAll('.class-card').forEach(card => {
        card.addEventListener('click', function() {
          const classId = this.getAttribute('data-class');
          showTopics(classId);
        });
      });
      
      // Setup back buttons
      document.getElementById('backToMainBtn').addEventListener('click', showMain);
      document.getElementById('backToTopicsBtn').addEventListener('click', backToTopics);
    });

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b84692625a6ae0b',t:'MTc2NzQ2MzM4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
